# Implementation Details (Chi Tiết Triển Khai)

## 1. Code Structure (Cấu Trúc Code)

```
src/
├── main.py                 # Entry point (điểm vào)
├── motion_detector.py      # Motion detection (phát hiện chuyển động)
├── adaptive_threshold.py   # Thresholding (ngưỡng hóa)
├── edge_detector.py        # Edge detection (phát hiện cạnh)
├── region_grower.py        # Region growing (tăng trưởng vùng)
├── intrusion_detector.py   # Intrusion logic (logic xâm nhập)
├── alert_system.py         # Alerts (cảnh báo)
└── utils.py                # Helper functions (hàm hỗ trợ)
```

---

## 2. Key Classes (Các Class Chính)

### MotionDetector Class

```python
class MotionDetector:
    def __init__(self, method, threshold):
        self.method = method
        self.bg_subtractor = self._create_subtractor()

    def detect(self, frame):
        # Áp dụng background subtraction
        fg_mask = self.bg_subtractor.apply(frame)
        return self._post_process(fg_mask)

    def get_contours(self, mask, min_area):
        # Tìm đường viền
        contours, _ = cv2.findContours(mask, ...)
        return [c for c in contours if cv2.contourArea(c) >= min_area]
```

### IntrusionDetector Class

```python
class IntrusionDetector:
    def __init__(self, rois, overlap_threshold, time_threshold):
        self.rois = rois
        self.tracking = defaultdict(dict)

    def detect_intrusions(self, contours, current_time):
        flags = []
        details = []

        for contour in contours:
            for roi in self.rois:
                # Tính độ chồng lấp
                overlap = self._calculate_overlap(contour, roi)
                if overlap >= self.overlap_threshold:
                    # Logic theo dõi...
                    if duration >= self.time_threshold:
                        flags.append(True)
                        details.append({...})

        return flags, details
```

---

## 3. Design Patterns (Các Mẫu Thiết Kế)

### A. Factory Pattern (Mẫu Nhà Máy)

```python
def create_motion_detector(config):
    # Tạo detector dựa trên cấu hình
    if config.motion.method == "MOG2":
        return MOG2Detector(config)
    elif config.motion.method == "KNN":
        return KNNDetector(config)
    else:
        return FrameDiffDetector(config)
```

### B. Strategy Pattern (Mẫu Chiến Lược)

```python
class ThresholdStrategy:
    def apply(self, image): pass

class GaussianThreshold(ThresholdStrategy):
    def apply(self, image):
        # Áp dụng ngưỡng hóa thích ứng Gaussian
        return cv2.adaptiveThreshold(...)

class OtsuThreshold(ThresholdStrategy):
    def apply(self, image):
        # Áp dụng ngưỡng hóa Otsu
        return cv2.threshold(..., cv2.THRESH_OTSU)
```

---

## 4. Error Handling (Xử Lý Lỗi)

```python
try:
    frame = process_frame(frame)
except cv2.error as e:
    logging.error(f"Lỗi OpenCV: {e}")
    continue
except Exception as e:
    logging.error(f"Lỗi không mong đợi: {e}")
    break
```

---

## 5. Performance Optimizations (Tối Ưu Hóa Hiệu Năng)

### A. Numpy Vectorization (Vector Hóa Numpy)

```python
# Chậm
for i in range(height):
    for j in range(width):
        result[i,j] = image[i,j] * 2

# Nhanh
result = image * 2
```

### B. Caching (Bộ Nhớ Đệm)

```python
@lru_cache(maxsize=128)
def expensive_computation(param):
    # Kết quả được cache
    return result
```

---

**Ngày tạo**: Tháng 1/2025
