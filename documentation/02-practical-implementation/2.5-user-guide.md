# Hướng Dẫn Sử Dụng

## 1. Quick Start

### Bước 1: Cài Đặt Môi Trường

```bash
# Tạo virtual environment
python -m venv venv

# Activate (Windows)
venv\Scripts\activate

# Activate (Linux/Mac)
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt
```

### Bước 2: Chuẩn Bị Video

```bash
# Copy video vào thư mục input
cp your_video.mp4 final-project/code/data/input/
```

### Bước 3: Định Nghĩa ROI

```bash
# Chạy ROI selector
cd final-project/code
python tools/roi_selector.py --video data/input/your_video.mp4
```

**Hướng dẫn trong ROI selector:**
- Click chuột trái để đánh dấu các điểm của polygon
- Nhấn 'r' để reset ROI hiện tại
- Nhấn 's' để lưu ROI
- Nhấn 'n' để tạo ROI mới
- Nhấn 'q' để kết thúc

### Bước 4: Cấu Hình

Chỉnh sửa `config/config.yaml`:

```yaml
video:
  source: "data/input/your_video.mp4"

intrusion:
  roi_file: "data/rois/roi_config.json"
```

### Bước 5: Chạy Hệ Thống

```bash
python src/main.py --config config/config.yaml
```

---

## 2. Command Line Options

### Basic Usage

```bash
python src/main.py [OPTIONS]
```

### Available Options

```bash
# Specify config file
python src/main.py --config path/to/config.yaml

# Use webcam
python src/main.py --camera 0

# Specify video file
python src/main.py --video path/to/video.mp4

# Save output video
python src/main.py --output output/result.mp4

# Show real-time display
python src/main.py --display

# Skip frames for performance
python src/main.py --skip-frames 2

# Resize for performance
python src/main.py --resize 0.5
```

### Combined Examples

```bash
# Process video with custom config, show display, save output
python src/main.py \
  --config config/custom.yaml \
  --video data/input/test.mp4 \
  --display \
  --output data/output/result.mp4

# Use webcam with default config
python src/main.py --camera 0 --display

# High performance mode
python src/main.py \
  --video data/input/test.mp4 \
  --skip-frames 2 \
  --resize 0.5 \
  --display
```

---

## 3. Keyboard Controls

Khi hiển thị real-time, các phím tắt sau có thể sử dụng:

| Phím | Chức năng |
|------|-----------|
| `q` | Thoát chương trình |
| `Space` | Pause/Resume video |
| `s` | Chụp screenshot |
| `r` | Reset background model |
| `d` | Toggle debug mode |
| `h` | Hide/Show ROI overlays |
| `+` | Increase motion threshold |
| `-` | Decrease motion threshold |

### Debug Mode

Khi bật debug mode (`d`), màn hình hiển thị:
- Foreground mask
- Edge detection result
- Contours
- ROI overlays
- FPS counter

---

## 4. Configuration Guide

### Video Settings

```yaml
video:
  source: "data/input/video.mp4"  # Video path hoặc camera index
  skip_frames: 0                   # Bỏ qua frames (0 = xử lý tất cả)
  resize_factor: 1.0               # Tỷ lệ resize (1.0 = full size)
  fps_limit: 30                    # Giới hạn FPS
```

**Khi nào dùng skip_frames:**
- Video có FPS cao (60+)
- CPU yếu
- Không cần real-time processing

**Khi nào dùng resize_factor:**
- Video resolution cao (1080p, 4K)
- Cần tốc độ xử lý nhanh
- Không cần chi tiết cao

### Motion Detection

```yaml
motion:
  method: "MOG2"        # "MOG2", "KNN", "FrameDiff"
  history: 500          # Số frames học background
  threshold: 16         # Độ nhạy (thấp = nhạy hơn)
  detect_shadows: true  # Phát hiện và loại bỏ shadows
```

**Chọn method:**
- **MOG2**: Tốt nhất cho hầu hết trường hợp
- **KNN**: Tốt với nhiễu, chậm hơn
- **FrameDiff**: Nhanh nhất, kém chính xác

### Intrusion Detection

```yaml
intrusion:
  roi_file: "data/rois/roi_config.json"
  overlap_threshold: 0.3    # 30% object phải nằm trong ROI
  time_threshold: 1.0       # Object phải ở trong ROI 1 giây
  min_contour_area: 500     # Diện tích tối thiểu (pixels)
```

**Điều chỉnh sensitivity:**

```yaml
# High sensitivity (nhiều alerts)
overlap_threshold: 0.2
time_threshold: 0.5

# Low sensitivity (ít alerts)
overlap_threshold: 0.5
time_threshold: 2.0
```

### Alert System

```yaml
alert:
  visual:
    enabled: true
    color: [0, 0, 255]      # BGR: Red
    thickness: 3

  audio:
    enabled: true
    frequency: 1000         # Hz
    duration: 200           # ms

  logging:
    enabled: true
    log_file: "logs/intrusions.log"
    save_screenshots: true
    screenshot_dir: "data/output/screenshots"

  cooldown: 5.0             # Seconds between alerts
```

### Output Settings

```yaml
output:
  show_realtime: true
  save_video: false
  video_path: "data/output/result.mp4"
  video_codec: "mp4v"
  save_logs: true
```

---

## 5. ROI Configuration

### Format của roi_config.json

```json
{
  "rois": [
    {
      "name": "Entrance",
      "type": "polygon",
      "points": [[100, 200], [300, 200], [300, 400], [100, 400]],
      "color": [0, 255, 0]
    },
    {
      "name": "Restricted Area",
      "type": "polygon",
      "points": [[500, 300], [700, 300], [700, 500], [500, 500]],
      "color": [0, 0, 255]
    }
  ]
}
```

### Tạo ROI Thủ Công

```python
# Calculate points từ frame
frame_width = 1920
frame_height = 1080

# ROI ở góc trên trái (10% width, 10% height)
roi = {
    "name": "Corner",
    "type": "polygon",
    "points": [
        [0, 0],
        [int(frame_width * 0.1), 0],
        [int(frame_width * 0.1), int(frame_height * 0.1)],
        [0, int(frame_height * 0.1)]
    ]
}
```

### Validate ROI

```bash
python tools/validate_roi.py --roi data/rois/roi_config.json --video data/input/video.mp4
```

---

## 6. Monitoring and Logging

### Log Files

```
final-project/code/logs/
├── intrusions.log          # Alert log
├── system.log              # System log
└── performance.log         # Performance metrics
```

### Log Format

```
[2025-01-15 14:23:45] INTRUSION DETECTED
ROI: Entrance
Object ID: 12345
Duration: 1.5 seconds
Overlap: 45%
Screenshot: data/output/screenshots/intrusion_20250115_142345.jpg
```

### Real-time Monitoring

```bash
# Watch intrusion log
tail -f logs/intrusions.log

# Watch system log
tail -f logs/system.log
```

---

## 7. Performance Optimization

### Low-End Hardware

```yaml
video:
  skip_frames: 2
  resize_factor: 0.5

motion:
  method: "FrameDiff"

morphology:
  iterations: 1

output:
  show_realtime: false
  save_video: false
```

### High-End Hardware

```yaml
video:
  skip_frames: 0
  resize_factor: 1.0

motion:
  method: "KNN"
  history: 1000

morphology:
  kernel_size: 7
  iterations: 3

region_growing:
  enabled: true

output:
  show_realtime: true
  save_video: true
```

### Benchmarking

```bash
# Test performance
python tools/benchmark.py \
  --config config/config.yaml \
  --video data/input/test.mp4 \
  --duration 60
```

Output:
```
Average FPS: 28.5
Processing time per frame: 35ms
Total frames processed: 1710
Intrusions detected: 5
False positives: 1
```

---

## 8. Troubleshooting

### Common Issues

#### Issue 1: "Video file not found"

```bash
# Check file path
ls data/input/your_video.mp4

# Use absolute path
python src/main.py --video /full/path/to/video.mp4
```

#### Issue 2: "No module named 'cv2'"

```bash
# Install OpenCV
pip install opencv-python opencv-contrib-python
```

#### Issue 3: "ROI file not found"

```bash
# Check ROI file exists
ls data/rois/roi_config.json

# Create ROI first
python tools/roi_selector.py --video data/input/video.mp4
```

#### Issue 4: Too many false positives

```yaml
# Increase thresholds
intrusion:
  overlap_threshold: 0.5
  time_threshold: 2.0
  min_contour_area: 1000

motion:
  threshold: 25
```

#### Issue 5: Missing detections

```yaml
# Decrease thresholds
intrusion:
  overlap_threshold: 0.2
  time_threshold: 0.5
  min_contour_area: 300

motion:
  threshold: 10
```

#### Issue 6: Low FPS

```yaml
# Optimize settings
video:
  skip_frames: 2
  resize_factor: 0.5

output:
  show_realtime: false
```

---

## 9. Best Practices

### 1. Testing New Videos

```bash
# Step 1: Test với video ngắn trước (30s-1min)
python src/main.py --video test_clip.mp4 --display

# Step 2: Điều chỉnh parameters
# Edit config.yaml based on results

# Step 3: Test với video đầy đủ
python src/main.py --video full_video.mp4 --output result.mp4
```

### 2. ROI Design

- Tránh vùng có nhiều chuyển động background (cây cối, nước)
- ROI không nên quá nhỏ (< 5% frame)
- ROI không nên quá lớn (> 50% frame)
- Overlap giữa các ROI là OK

### 3. Lighting Conditions

```yaml
# Daylight - stable
motion:
  threshold: 20

# Indoor - artificial light
preprocessing:
  use_clahe: true

# Night - very dark
motion:
  method: "FrameDiff"
  threshold: 30
preprocessing:
  use_clahe: true
  clip_limit: 3.0
```

### 4. Multiple ROIs

```json
{
  "rois": [
    {
      "name": "Main Entrance",
      "priority": "high",
      "alert_type": "immediate"
    },
    {
      "name": "Parking Area",
      "priority": "low",
      "alert_type": "delayed"
    }
  ]
}
```

---

## 10. Integration Examples

### A. Save to Database

```python
from alert_system import AlertSystem

class DatabaseAlertSystem(AlertSystem):
    def trigger_alert(self, frame, details):
        super().trigger_alert(frame, details)

        # Save to database
        self.db.insert({
            'timestamp': details['timestamp'],
            'roi_name': details['roi_name'],
            'screenshot': details['screenshot_path']
        })
```

### B. Send Email Notification

```python
import smtplib
from email.mime.text import MIMEText

def send_alert_email(details):
    msg = MIMEText(f"Intrusion detected at {details['roi_name']}")
    msg['Subject'] = 'Security Alert'
    msg['From'] = 'security@example.com'
    msg['To'] = 'admin@example.com'

    with smtplib.SMTP('localhost') as server:
        server.send_message(msg)
```

### C. REST API Integration

```python
import requests

def post_alert(details):
    response = requests.post(
        'https://api.example.com/alerts',
        json={
            'location': details['roi_name'],
            'time': details['timestamp'],
            'image_url': details['screenshot_path']
        }
    )
    return response.status_code
```

---

## 11. Maintenance

### Regular Tasks

```bash
# Weekly: Clean old logs
python tools/clean_logs.py --days 7

# Monthly: Archive old screenshots
python tools/archive_screenshots.py --month 1

# Daily: Check system status
python tools/health_check.py
```

### Update Configuration

```bash
# Backup current config
cp config/config.yaml config/config.yaml.backup

# Test new config
python src/main.py --config config/config_new.yaml --video test.mp4

# If OK, replace
mv config/config_new.yaml config/config.yaml
```

---

## 12. Advanced Usage

### Multi-Camera Setup

```bash
# Camera 1
python src/main.py --config config/camera1.yaml --camera 0 &

# Camera 2
python src/main.py --config config/camera2.yaml --camera 1 &

# Camera 3
python src/main.py --config config/camera3.yaml --camera 2 &
```

### Scheduled Recording

```bash
# Crontab entry: Run every day from 6 PM to 6 AM
0 18 * * * /path/to/start_surveillance.sh
0 6 * * * /path/to/stop_surveillance.sh
```

### Remote Monitoring

```python
# Stream processed frames via Flask
from flask import Flask, Response

app = Flask(__name__)

@app.route('/video_feed')
def video_feed():
    return Response(
        generate_frames(),
        mimetype='multipart/x-mixed-replace; boundary=frame'
    )
```

---

**Ngày tạo**: Tháng 1/2025
