# User Guide (Hướng Dẫn Sử Dụng)

## 1. Quick Start (Bắt Đầu Nhanh)

### Bước 1: Cài Đặt Môi Trường

```bash
# Tạo virtual environment (môi trường ảo)
python -m venv venv

# Kích hoạt (Windows)
venv\Scripts\activate

# Kích hoạt (Linux/Mac)
source venv/bin/activate

# Cài đặt dependencies (phụ thuộc)
pip install -r requirements.txt
```

### Bước 2: Chuẩn Bị Video

```bash
# Sao chép video vào thư mục input
cp your_video.mp4 final-project/code/data/input/
```

### Bước 3: Định Nghĩa ROI

```bash
# Chạy ROI selector (bộ chọn ROI)
cd final-project/code
python tools/roi_selector.py --video data/input/your_video.mp4
```

**Hướng dẫn trong ROI selector:**
- Click chuột trái để đánh dấu các điểm của polygon (đa giác)
- Nhấn 'r' để reset ROI hiện tại
- Nhấn 's' để lưu ROI
- Nhấn 'n' để tạo ROI mới
- Nhấn 'q' để kết thúc

### Bước 4: Cấu Hình

Chỉnh sửa `config/config.yaml`:

```yaml
video:
  source: "data/input/your_video.mp4"

intrusion:
  roi_file: "data/rois/roi_config.json"
```

### Bước 5: Chạy Hệ Thống

```bash
python src/main.py --config config/config.yaml
```

---

## 2. Command Line Options (Tùy Chọn Dòng Lệnh)

### Basic Usage (Sử Dụng Cơ Bản)

```bash
python src/main.py [OPTIONS]
```

### Available Options (Các Tùy Chọn Có Sẵn)

```bash
# Chỉ định file cấu hình
python src/main.py --config path/to/config.yaml

# Sử dụng webcam
python src/main.py --camera 0

# Chỉ định file video
python src/main.py --video path/to/video.mp4

# Lưu video đầu ra
python src/main.py --output output/result.mp4

# Hiển thị real-time (thời gian thực)
python src/main.py --display

# Bỏ qua khung hình để tăng hiệu năng
python src/main.py --skip-frames 2

# Thay đổi kích thước để tăng hiệu năng
python src/main.py --resize 0.5
```

### Combined Examples (Ví Dụ Kết Hợp)

```bash
# Xử lý video với cấu hình tùy chỉnh, hiển thị, lưu đầu ra
python src/main.py \
  --config config/custom.yaml \
  --video data/input/test.mp4 \
  --display \
  --output data/output/result.mp4

# Sử dụng webcam với cấu hình mặc định
python src/main.py --camera 0 --display

# Chế độ hiệu năng cao
python src/main.py \
  --video data/input/test.mp4 \
  --skip-frames 2 \
  --resize 0.5 \
  --display
```

---

## 3. Keyboard Controls (Điều Khiển Bàn Phím)

Khi hiển thị real-time, các phím tắt sau có thể sử dụng:

| Phím | Chức năng |
|------|-----------|
| `q` | Thoát chương trình |
| `Space` | Tạm dừng/Tiếp tục video |
| `s` | Chụp screenshot (ảnh chụp màn hình) |
| `r` | Reset background model (mô hình nền) |
| `d` | Bật/Tắt debug mode (chế độ gỡ lỗi) |
| `h` | Ẩn/Hiện ROI overlays (lớp phủ ROI) |
| `+` | Tăng motion threshold (ngưỡng chuyển động) |
| `-` | Giảm motion threshold |

### Debug Mode (Chế Độ Gỡ Lỗi)

Khi bật debug mode (`d`), màn hình hiển thị:
- Foreground mask (mặt nạ tiền cảnh)
- Edge detection result (kết quả phát hiện cạnh)
- Contours (đường viền)
- ROI overlays (lớp phủ ROI)
- FPS counter (bộ đếm FPS)

---

## 4. Configuration Guide (Hướng Dẫn Cấu Hình)

### Video Settings (Cài Đặt Video)

```yaml
video:
  source: "data/input/video.mp4"  # Video path hoặc camera index
  skip_frames: 0                   # Bỏ qua khung hình (0 = xử lý tất cả)
  resize_factor: 1.0               # Tỷ lệ resize (1.0 = kích thước đầy đủ)
  fps_limit: 30                    # Giới hạn FPS
```

**Khi nào dùng skip_frames:**
- Video có FPS cao (60+)
- CPU yếu
- Không cần xử lý real-time

**Khi nào dùng resize_factor:**
- Video resolution (độ phân giải) cao (1080p, 4K)
- Cần tốc độ xử lý nhanh
- Không cần chi tiết cao

### Motion Detection (Phát Hiện Chuyển Động)

```yaml
motion:
  method: "MOG2"        # "MOG2", "KNN", "FrameDiff"
  history: 500          # Số khung hình học nền
  threshold: 16         # Độ nhạy (thấp = nhạy hơn)
  detect_shadows: true  # Phát hiện và loại bỏ shadows (bóng đổ)
```

**Chọn method (phương pháp):**
- **MOG2**: Tốt nhất cho hầu hết trường hợp
- **KNN**: Tốt với nhiễu, chậm hơn
- **FrameDiff**: Nhanh nhất, kém chính xác

### Intrusion Detection (Phát Hiện Xâm Nhập)

```yaml
intrusion:
  roi_file: "data/rois/roi_config.json"
  overlap_threshold: 0.3    # 30% đối tượng phải nằm trong ROI
  time_threshold: 1.0       # Đối tượng phải ở trong ROI 1 giây
  min_contour_area: 500     # Diện tích tối thiểu (pixels)
```

**Điều chỉnh sensitivity (độ nhạy):**

```yaml
# High sensitivity (độ nhạy cao - nhiều cảnh báo)
overlap_threshold: 0.2
time_threshold: 0.5

# Low sensitivity (độ nhạy thấp - ít cảnh báo)
overlap_threshold: 0.5
time_threshold: 2.0
```

### Alert System (Hệ Thống Cảnh Báo)

```yaml
alert:
  visual:
    enabled: true
    color: [0, 0, 255]      # BGR: Đỏ
    thickness: 3

  audio:
    enabled: true
    frequency: 1000         # Hz
    duration: 200           # ms

  logging:
    enabled: true
    log_file: "logs/intrusions.log"
    save_screenshots: true
    screenshot_dir: "data/output/screenshots"

  cooldown: 5.0             # Giây giữa các cảnh báo
```

### Output Settings (Cài Đặt Đầu Ra)

```yaml
output:
  show_realtime: true
  save_video: false
  video_path: "data/output/result.mp4"
  video_codec: "mp4v"
  save_logs: true
```

---

## 5. ROI Configuration (Cấu Hình ROI)

### Format (Định Dạng) của roi_config.json

```json
{
  "rois": [
    {
      "name": "Entrance",
      "type": "polygon",
      "points": [[100, 200], [300, 200], [300, 400], [100, 400]],
      "color": [0, 255, 0]
    },
    {
      "name": "Restricted Area",
      "type": "polygon",
      "points": [[500, 300], [700, 300], [700, 500], [500, 500]],
      "color": [0, 0, 255]
    }
  ]
}
```

### Tạo ROI Thủ Công

```python
# Tính toán points (điểm) từ frame (khung hình)
frame_width = 1920
frame_height = 1080

# ROI ở góc trên trái (10% width, 10% height)
roi = {
    "name": "Corner",
    "type": "polygon",
    "points": [
        [0, 0],
        [int(frame_width * 0.1), 0],
        [int(frame_width * 0.1), int(frame_height * 0.1)],
        [0, int(frame_height * 0.1)]
    ]
}
```

### Validate ROI (Xác Thực ROI)

```bash
python tools/validate_roi.py --roi data/rois/roi_config.json --video data/input/video.mp4
```

---

## 6. Monitoring and Logging (Giám Sát và Ghi Nhật Ký)

### Log Files (File Nhật Ký)

```
final-project/code/logs/
├── intrusions.log          # Nhật ký cảnh báo
├── system.log              # Nhật ký hệ thống
└── performance.log         # Chỉ số hiệu năng
```

### Log Format (Định Dạng Nhật Ký)

```
[2025-01-15 14:23:45] INTRUSION DETECTED (Phát hiện xâm nhập)
ROI: Entrance
Object ID: 12345
Duration (Thời lượng): 1.5 seconds
Overlap (Chồng lấp): 45%
Screenshot: data/output/screenshots/intrusion_20250115_142345.jpg
```

### Real-time Monitoring (Giám Sát Thời Gian Thực)

```bash
# Theo dõi nhật ký xâm nhập
tail -f logs/intrusions.log

# Theo dõi nhật ký hệ thống
tail -f logs/system.log
```

---

## 7. Performance Optimization (Tối Ưu Hóa Hiệu Năng)

### Low-End Hardware (Phần Cứng Yếu)

```yaml
video:
  skip_frames: 2
  resize_factor: 0.5

motion:
  method: "FrameDiff"

morphology:
  iterations: 1

output:
  show_realtime: false
  save_video: false
```

### High-End Hardware (Phần Cứng Mạnh)

```yaml
video:
  skip_frames: 0
  resize_factor: 1.0

motion:
  method: "KNN"
  history: 1000

morphology:
  kernel_size: 7
  iterations: 3

region_growing:
  enabled: true

output:
  show_realtime: true
  save_video: true
```

### Benchmarking (Đánh Giá Hiệu Năng)

```bash
# Kiểm tra hiệu năng
python tools/benchmark.py \
  --config config/config.yaml \
  --video data/input/test.mp4 \
  --duration 60
```

Output (Đầu ra):
```
Average FPS (FPS trung bình): 28.5
Processing time per frame (Thời gian xử lý mỗi khung hình): 35ms
Total frames processed (Tổng số khung hình đã xử lý): 1710
Intrusions detected (Xâm nhập được phát hiện): 5
False positives (Dương tính giả): 1
```

---

## 8. Troubleshooting (Khắc Phục Sự Cố)

### Common Issues (Vấn Đề Thường Gặp)

#### Issue 1: "Video file not found" (Không tìm thấy file video)

```bash
# Kiểm tra đường dẫn file
ls data/input/your_video.mp4

# Sử dụng đường dẫn tuyệt đối
python src/main.py --video /full/path/to/video.mp4
```

#### Issue 2: "No module named 'cv2'" (Không có module tên 'cv2')

```bash
# Cài đặt OpenCV
pip install opencv-python opencv-contrib-python
```

#### Issue 3: "ROI file not found" (Không tìm thấy file ROI)

```bash
# Kiểm tra file ROI tồn tại
ls data/rois/roi_config.json

# Tạo ROI trước
python tools/roi_selector.py --video data/input/video.mp4
```

#### Issue 4: Too many false positives (Quá nhiều dương tính giả)

```yaml
# Tăng ngưỡng
intrusion:
  overlap_threshold: 0.5
  time_threshold: 2.0
  min_contour_area: 1000

motion:
  threshold: 25
```

#### Issue 5: Missing detections (Bỏ lỡ phát hiện)

```yaml
# Giảm ngưỡng
intrusion:
  overlap_threshold: 0.2
  time_threshold: 0.5
  min_contour_area: 300

motion:
  threshold: 10
```

#### Issue 6: Low FPS (FPS thấp)

```yaml
# Tối ưu cài đặt
video:
  skip_frames: 2
  resize_factor: 0.5

output:
  show_realtime: false
```

---

## 9. Best Practices (Thực Hành Tốt Nhất)

### 1. Testing New Videos (Kiểm Tra Video Mới)

```bash
# Bước 1: Kiểm tra với video ngắn trước (30s-1min)
python src/main.py --video test_clip.mp4 --display

# Bước 2: Điều chỉnh tham số
# Chỉnh sửa config.yaml dựa trên kết quả

# Bước 3: Kiểm tra với video đầy đủ
python src/main.py --video full_video.mp4 --output result.mp4
```

### 2. ROI Design (Thiết Kế ROI)

- Tránh vùng có nhiều chuyển động background (nền) (cây cối, nước)
- ROI không nên quá nhỏ (< 5% frame)
- ROI không nên quá lớn (> 50% frame)
- Overlap (chồng lấp) giữa các ROI là OK

### 3. Lighting Conditions (Điều Kiện Ánh Sáng)

```yaml
# Ban ngày - ổn định
motion:
  threshold: 20

# Trong nhà - ánh sáng nhân tạo
preprocessing:
  use_clahe: true

# Ban đêm - rất tối
motion:
  method: "FrameDiff"
  threshold: 30
preprocessing:
  use_clahe: true
  clip_limit: 3.0
```

### 4. Multiple ROIs (Nhiều ROI)

```json
{
  "rois": [
    {
      "name": "Main Entrance",
      "priority": "high",
      "alert_type": "immediate"
    },
    {
      "name": "Parking Area",
      "priority": "low",
      "alert_type": "delayed"
    }
  ]
}
```

---

## 10. Integration Examples (Ví Dụ Tích Hợp)

### A. Save to Database (Lưu vào Cơ Sở Dữ Liệu)

```python
from alert_system import AlertSystem

class DatabaseAlertSystem(AlertSystem):
    def trigger_alert(self, frame, details):
        super().trigger_alert(frame, details)

        # Lưu vào cơ sở dữ liệu
        self.db.insert({
            'timestamp': details['timestamp'],
            'roi_name': details['roi_name'],
            'screenshot': details['screenshot_path']
        })
```

### B. Send Email Notification (Gửi Thông Báo Email)

```python
import smtplib
from email.mime.text import MIMEText

def send_alert_email(details):
    msg = MIMEText(f"Phát hiện xâm nhập tại {details['roi_name']}")
    msg['Subject'] = 'Security Alert'
    msg['From'] = 'security@example.com'
    msg['To'] = 'admin@example.com'

    with smtplib.SMTP('localhost') as server:
        server.send_message(msg)
```

### C. REST API Integration (Tích Hợp REST API)

```python
import requests

def post_alert(details):
    response = requests.post(
        'https://api.example.com/alerts',
        json={
            'location': details['roi_name'],
            'time': details['timestamp'],
            'image_url': details['screenshot_path']
        }
    )
    return response.status_code
```

---

## 11. Maintenance (Bảo Trì)

### Regular Tasks (Tác Vụ Định Kỳ)

```bash
# Hàng tuần: Dọn dẹp nhật ký cũ
python tools/clean_logs.py --days 7

# Hàng tháng: Lưu trữ ảnh chụp màn hình cũ
python tools/archive_screenshots.py --month 1

# Hàng ngày: Kiểm tra trạng thái hệ thống
python tools/health_check.py
```

### Update Configuration (Cập Nhật Cấu Hình)

```bash
# Sao lưu cấu hình hiện tại
cp config/config.yaml config/config.yaml.backup

# Kiểm tra cấu hình mới
python src/main.py --config config/config_new.yaml --video test.mp4

# Nếu OK, thay thế
mv config/config_new.yaml config/config.yaml
```

---

## 12. Advanced Usage (Sử Dụng Nâng Cao)

### Multi-Camera Setup (Thiết Lập Nhiều Camera)

```bash
# Camera 1
python src/main.py --config config/camera1.yaml --camera 0 &

# Camera 2
python src/main.py --config config/camera2.yaml --camera 1 &

# Camera 3
python src/main.py --config config/camera3.yaml --camera 2 &
```

### Scheduled Recording (Ghi Hình Theo Lịch)

```bash
# Crontab entry: Chạy mỗi ngày từ 6 giờ chiều đến 6 giờ sáng
0 18 * * * /path/to/start_surveillance.sh
0 6 * * * /path/to/stop_surveillance.sh
```

### Remote Monitoring (Giám Sát Từ Xa)

```python
# Stream (truyền) các khung hình đã xử lý qua Flask
from flask import Flask, Response

app = Flask(__name__)

@app.route('/video_feed')
def video_feed():
    return Response(
        generate_frames(),
        mimetype='multipart/x-mixed-replace; boundary=frame'
    )
```

---

**Ngày tạo**: Tháng 1/2025
