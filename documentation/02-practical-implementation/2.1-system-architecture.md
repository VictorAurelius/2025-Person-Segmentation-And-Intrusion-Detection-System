# System Architecture (Kiến Trúc Hệ Thống)

## 1. Tổng Quan

Hệ thống phát hiện xâm nhập được xây dựng theo kiến trúc pipeline (đường ống xử lý), xử lý tuần tự qua các modules (mô-đun).

---

## 2. Sơ Đồ Kiến Trúc Hệ Thống

```
[Video Input (Đầu vào video)]
    ↓
[Preprocessing (Tiền xử lý)]
    ↓
[Motion Detection (Phát hiện chuyển động)] ← [Background Model (Mô hình nền)]
    ↓
[Adaptive Thresholding (Ngưỡng hóa thích ứng)]
    ↓
[Edge Detection (Phát hiện cạnh)]
    ↓
[Region Growing (Tăng trưởng vùng)] → [Object Segmentation (Phân vùng đối tượng)]
    ↓
[Contour Detection (Phát hiện đường viền)]
    ↓
[Intrusion Detection (Phát hiện xâm nhập)] ← [ROI Database (Cơ sở dữ liệu ROI)]
    ↓
[Alert System (Hệ thống cảnh báo)] → [Visual + Audio + Log (Hình ảnh + Âm thanh + Nhật ký)]
    ↓
[Output Display/Save (Hiển thị/Lưu đầu ra)]
```

---

## 3. Các Module (Mô-Đun) Chính

### 1. Video Input Module (Mô-đun đầu vào video)
- **Chức năng**: Đọc video từ file hoặc camera
- **Input (Đầu vào)**: Video path (đường dẫn video) hoặc camera index (chỉ số camera)
- **Output (Đầu ra)**: Frame sequence (chuỗi khung hình)
- **Class**: `cv2.VideoCapture`

### 2. Motion Detection Module (Mô-đun phát hiện chuyển động)
- **Chức năng**: Phát hiện chuyển động
- **Algorithms (Thuật toán)**: MOG2, KNN, Frame Differencing (phép trừ khung hình)
- **Input (Đầu vào)**: Frame (khung hình)
- **Output (Đầu ra)**: Foreground mask (mặt nạ tiền cảnh)
- **File**: `motion_detector.py`

### 3. Adaptive Thresholding Module (Mô-đun ngưỡng hóa thích ứng)
- **Chức năng**: Xử lý ánh sáng không đồng đều
- **Algorithms (Thuật toán)**: Gaussian, Mean, Otsu
- **Input (Đầu vào)**: Grayscale image (ảnh xám)
- **Output (Đầu ra)**: Binary image (ảnh nhị phân)
- **File**: `adaptive_threshold.py`

### 4. Edge Detection Module (Mô-đun phát hiện cạnh)
- **Chức năng**: Phát hiện biên của objects (đối tượng)
- **Algorithms (Thuật toán)**: Canny, Sobel
- **Input (Đầu vào)**: Grayscale image (ảnh xám)
- **Output (Đầu ra)**: Edge map (bản đồ cạnh)
- **File**: `edge_detector.py`

### 5. Region Growing Module (Mô-đun tăng trưởng vùng)
- **Chức năng**: Segmentation (phân vùng) dựa trên similarity (độ tương đồng)
- **Input (Đầu vào)**: Image (ảnh) + seed points (điểm mầm)
- **Output (Đầu ra)**: Segmented regions (các vùng đã phân vùng)
- **File**: `region_grower.py`

### 6. Intrusion Detection Module (Mô-đun phát hiện xâm nhập)
- **Chức năng**: Phát hiện xâm nhập vào ROI (Region of Interest - vùng quan tâm)
- **Input (Đầu vào)**: Contours (đường viền) + ROI definitions (định nghĩa ROI)
- **Output (Đầu ra)**: Intrusion flags (cờ xâm nhập) + details (chi tiết)
- **File**: `intrusion_detector.py`

### 7. Alert System Module (Mô-đun hệ thống cảnh báo)
- **Chức năng**: Cảnh báo khi phát hiện xâm nhập
- **Output (Đầu ra)**: Visual/Audio/Log alerts (cảnh báo hình ảnh/âm thanh/nhật ký)
- **File**: `alert_system.py`

---

## 4. Data Flow (Luồng Dữ Liệu)

```python
# Vòng lặp xử lý chính
while True:
    # 1. Đọc khung hình
    ret, frame = video_capture.read()

    # 2. Phát hiện chuyển động
    fg_mask = motion_detector.detect(frame)

    # 3. Tìm đường viền
    contours = cv2.findContours(fg_mask, ...)

    # 4. Phát hiện xâm nhập
    flags, details = intrusion_detector.detect(contours, rois)

    # 5. Cảnh báo nếu cần
    if details:
        alert_system.trigger(frame, details)

    # 6. Hiển thị/Lưu
    output_frame = visualize(frame, contours, flags)
```

---

## 5. Configuration System (Hệ Thống Cấu Hình)

```yaml
# config.yaml
video:
  source: "path/to/video.mp4"

motion:
  method: "MOG2"
  threshold: 16

intrusion:
  roi_file: "roi.json"
  overlap_threshold: 0.3
```

Tất cả parameters (tham số) được tập trung hóa trong file config.

---

## 6. Module Interactions (Tương Tác Giữa Các Module)

```
     ┌─────────────┐
     │   main.py   │
     └──────┬──────┘
            │
    ┌───────┼───────┐
    │       │       │
    v       v       v
[Motion] [Edge] [Threshold]
    │       │       │
    └───────┼───────┘
            v
     [Intrusion]
            │
            v
        [Alert]
```

---

## 7. Real-time Considerations (Các Cân Nhắc Thời Gian Thực)

### Performance Optimization (Tối Ưu Hóa Hiệu Năng)
- **Skip frames (Bỏ qua khung hình)**: Xử lý mỗi frame thứ 2
- **Resize (Thay đổi kích thước)**: Giảm resolution (độ phân giải)
- **ROI**: Chỉ xử lý vùng quan tâm
- **Threading (Đa luồng)**: Tách display (hiển thị) và processing (xử lý)

### Resource Management (Quản Lý Tài Nguyên)
- **Memory (Bộ nhớ)**: Giải phóng frames cũ
- **CPU**: Tối ưu algorithms (thuật toán)
- **Disk (Đĩa)**: Quản lý output size (kích thước đầu ra)

---

**Ngày tạo**: Tháng 1/2025
