# Kiến Trúc Hệ Thống

## 1. Tổng Quan

Hệ thống phát hiện xâm nhập được xây dựng theo kiến trúc pipeline, xử lý tuần tự qua các modules.

---

## 2. System Architecture Diagram

```
[Video Input]
    ↓
[Preprocessing]
    ↓
[Motion Detection] ← [Background Model]
    ↓
[Adaptive Thresholding]
    ↓
[Edge Detection]
    ↓
[Region Growing] → [Object Segmentation]
    ↓
[Contour Detection]
    ↓
[Intrusion Detection] ← [ROI Database]
    ↓
[Alert System] → [Visual + Audio + Log]
    ↓
[Output Display/Save]
```

---

## 3. Các Module Chính

### 1. Video Input Module
- **Chức năng**: Đọc video từ file/camera
- **Input**: Video path hoặc camera index
- **Output**: Frame sequence
- **Class**: `cv2.VideoCapture`

### 2. Motion Detection Module
- **Chức năng**: Phát hiện chuyển động
- **Algorithms**: MOG2, KNN, Frame Differencing
- **Input**: Frame
- **Output**: Foreground mask
- **File**: `motion_detector.py`

### 3. Adaptive Thresholding Module
- **Chức năng**: Xử lý ánh sáng không đồng đều
- **Algorithms**: Gaussian, Mean, Otsu
- **Input**: Grayscale image
- **Output**: Binary image
- **File**: `adaptive_threshold.py`

### 4. Edge Detection Module
- **Chức năng**: Phát hiện biên objects
- **Algorithms**: Canny, Sobel
- **Input**: Grayscale image
- **Output**: Edge map
- **File**: `edge_detector.py`

### 5. Region Growing Module
- **Chức năng**: Segmentation based on similarity
- **Input**: Image + seed points
- **Output**: Segmented regions
- **File**: `region_grower.py`

### 6. Intrusion Detection Module
- **Chức năng**: Phát hiện xâm nhập vào ROI
- **Input**: Contours + ROI definitions
- **Output**: Intrusion flags + details
- **File**: `intrusion_detector.py`

### 7. Alert System Module
- **Chức năng**: Cảnh báo khi phát hiện
- **Output**: Visual/Audio/Log alerts
- **File**: `alert_system.py`

---

## 4. Data Flow

```python
# Main processing loop
while True:
    # 1. Read frame
    ret, frame = video_capture.read()

    # 2. Motion detection
    fg_mask = motion_detector.detect(frame)

    # 3. Find contours
    contours = cv2.findContours(fg_mask, ...)

    # 4. Intrusion detection
    flags, details = intrusion_detector.detect(contours, rois)

    # 5. Alert if needed
    if details:
        alert_system.trigger(frame, details)

    # 6. Display/Save
    output_frame = visualize(frame, contours, flags)
```

---

## 5. Configuration System

```yaml
# config.yaml
video:
  source: "path/to/video.mp4"

motion:
  method: "MOG2"
  threshold: 16

intrusion:
  roi_file: "roi.json"
  overlap_threshold: 0.3
```

Tất cả parameters được centralized trong file config.

---

## 6. Module Interactions

```
     ┌─────────────┐
     │   main.py   │
     └──────┬──────┘
            │
    ┌───────┼───────┐
    │       │       │
    v       v       v
[Motion] [Edge] [Threshold]
    │       │       │
    └───────┼───────┘
            v
     [Intrusion]
            │
            v
        [Alert]
```

---

## 7. Real-time Considerations

### Performance Optimization
- **Skip frames**: Xử lý mỗi frame thứ 2
- **Resize**: Giảm resolution
- **ROI**: Chỉ xử lý vùng quan tâm
- **Threading**: Tách display và processing

### Resource Management
- **Memory**: Giải phóng frames cũ
- **CPU**: Tối ưu algorithms
- **Disk**: Quản lý output size

---

**Ngày tạo**: Tháng 1/2025
