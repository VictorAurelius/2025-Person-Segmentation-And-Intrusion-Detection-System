# Thiết Kế Thuật Toán

## 1. Main Detection Algorithm

### Flowchart

```
START
  ↓
Load Config & ROI
  ↓
Open Video Source
  ↓
Initialize Background Model
  ↓
FOR each frame:
  ↓
  Motion Detection
  ↓
  Morphological Processing
  ↓
  Find Contours
  ↓
  FOR each contour:
    ↓
    Size Filter?
    ↓ Yes
    FOR each ROI:
      ↓
      Calculate Overlap
      ↓
      Overlap > threshold?
      ↓ Yes
      Update Tracking
      ↓
      Duration > time_threshold?
      ↓ Yes
      TRIGGER ALERT
  ↓
  Display/Save
  ↓
END FOR
  ↓
Clean up & Exit
```

---

## 2. Pseudocode Chi Tiết

### Main Loop

```python
def main_detection_loop():
    # Initialization
    config = load_config()
    rois = load_roi()
    motion_detector = MotionDetector(config)
    intrusion_detector = IntrusionDetector(rois, config)
    alert_system = AlertSystem(config)

    cap = open_video(config.video.source)

    # Main loop
    while cap.isOpened():
        ret, frame = cap.read()
        if not ret:
            break

        # Processing pipeline
        fg_mask = motion_detector.detect(frame)
        contours = find_contours(fg_mask, min_area)

        current_time = get_current_time()
        flags, details = intrusion_detector.detect_intrusions(
            contours, current_time
        )

        # Alert if needed
        if details:
            frame = alert_system.trigger_alert(frame, details)

        # Visualize
        frame = draw_roi(frame, rois)
        frame = draw_bounding_boxes(frame, contours, flags)

        # Display/Save
        if config.output.show_realtime:
            display(frame)

        if config.output.save_video:
            writer.write(frame)

    # Cleanup
    cap.release()
    writer.release()
```

---

## 3. Decision Trees

### Motion Detection Method Selection

```
Ánh sáng thay đổi nhiều?
├─ Yes → MOG2 (adaptive)
└─ No
   ├─ Cần tốc độ cao?
   │  ├─ Yes → Frame Differencing
   │  └─ No → KNN
   └─ Có shadows?
      ├─ Yes → MOG2 với detectShadows=True
      └─ No → MOG2 hoặc KNN
```

### Threshold Method Selection

```
Ánh sáng đồng đều?
├─ Yes
│  └─ Histogram bimodal?
│     ├─ Yes → Otsu
│     └─ No → Global threshold
└─ No (ánh sáng không đều)
   └─ Gradient mượt?
      ├─ Yes → Adaptive Gaussian
      └─ No → Adaptive Mean
```

---

## 4. Edge Case Handling

### A. Empty Frames
```python
if frame is None or frame.size == 0:
    log_error("Empty frame received")
    continue
```

### B. No Motion Detected
```python
if len(contours) == 0:
    # Reset tracking after timeout
    cleanup_old_tracking()
    continue
```

### C. Multiple Objects
```python
# Track each object separately
for contour in contours:
    object_id = assign_id(contour)
    process_object(contour, object_id)
```

### D. Occlusions
```python
# Maintain object tracking even when temporarily hidden
if object_id in tracking:
    tracking[object_id]['missing_frames'] += 1
    if tracking[object_id]['missing_frames'] > max_missing:
        del tracking[object_id]
```

---

## 5. Parameter Auto-tuning Logic

```python
def auto_tune_parameters(frame_samples):
    # Analyze lighting
    mean_brightness = np.mean(frame_samples)

    if mean_brightness < 50:  # Dark
        config.motion.threshold = 10
        config.threshold.block_size = 21
    elif mean_brightness > 200:  # Very bright
        config.motion.threshold = 25
        config.threshold.block_size = 11
    else:  # Normal
        config.motion.threshold = 16
        config.threshold.block_size = 11

    # Analyze noise level
    noise_level = estimate_noise(frame_samples)
    if noise_level > threshold:
        config.morphology.kernel_size = 7
        config.morphology.iterations = 3

    return config
```

---

**Ngày tạo**: Tháng 1/2025
