# Algorithm Design (Thiết Kế Thuật Toán)

## 1. Main Detection Algorithm (Thuật Toán Phát Hiện Chính)

### Flowchart (Lưu Đồ)

```
START
  ↓
Load Config & ROI (Tải cấu hình & ROI)
  ↓
Open Video Source (Mở nguồn video)
  ↓
Initialize Background Model (Khởi tạo mô hình nền)
  ↓
FOR each frame (Với mỗi khung hình):
  ↓
  Motion Detection (Phát hiện chuyển động)
  ↓
  Morphological Processing (Xử lý hình thái)
  ↓
  Find Contours (Tìm đường viền)
  ↓
  FOR each contour (Với mỗi đường viền):
    ↓
    Size Filter? (Lọc kích thước?)
    ↓ Yes
    FOR each ROI (Với mỗi ROI):
      ↓
      Calculate Overlap (Tính độ chồng lấp)
      ↓
      Overlap > threshold? (Độ chồng lấp > ngưỡng?)
      ↓ Yes
      Update Tracking (Cập nhật theo dõi)
      ↓
      Duration > time_threshold? (Thời lượng > ngưỡng thời gian?)
      ↓ Yes
      TRIGGER ALERT (KÍCH HOẠT CẢNH BÁO)
  ↓
  Display/Save (Hiển thị/Lưu)
  ↓
END FOR
  ↓
Clean up & Exit (Dọn dẹp & Thoát)
```

---

## 2. Pseudocode Chi Tiết

### Main Loop (Vòng Lặp Chính)

```python
def main_detection_loop():
    # Khởi tạo
    config = load_config()
    rois = load_roi()
    motion_detector = MotionDetector(config)
    intrusion_detector = IntrusionDetector(rois, config)
    alert_system = AlertSystem(config)

    cap = open_video(config.video.source)

    # Vòng lặp chính
    while cap.isOpened():
        ret, frame = cap.read()
        if not ret:
            break

        # Pipeline xử lý
        fg_mask = motion_detector.detect(frame)
        contours = find_contours(fg_mask, min_area)

        current_time = get_current_time()
        flags, details = intrusion_detector.detect_intrusions(
            contours, current_time
        )

        # Cảnh báo nếu cần
        if details:
            frame = alert_system.trigger_alert(frame, details)

        # Trực quan hóa
        frame = draw_roi(frame, rois)
        frame = draw_bounding_boxes(frame, contours, flags)

        # Hiển thị/Lưu
        if config.output.show_realtime:
            display(frame)

        if config.output.save_video:
            writer.write(frame)

    # Dọn dẹp
    cap.release()
    writer.release()
```

---

## 3. Decision Trees (Cây Quyết Định)

### Motion Detection Method Selection (Lựa Chọn Phương Pháp Phát Hiện Chuyển Động)

```
Ánh sáng thay đổi nhiều?
├─ Yes → MOG2 (adaptive - thích ứng)
└─ No
   ├─ Cần tốc độ cao?
   │  ├─ Yes → Frame Differencing (phép trừ khung hình)
   │  └─ No → KNN
   └─ Có shadows (bóng đổ)?
      ├─ Yes → MOG2 với detectShadows=True
      └─ No → MOG2 hoặc KNN
```

### Threshold Method Selection (Lựa Chọn Phương Pháp Ngưỡng Hóa)

```
Ánh sáng đồng đều?
├─ Yes
│  └─ Histogram bimodal (biểu đồ hai đỉnh)?
│     ├─ Yes → Otsu
│     └─ No → Global threshold (ngưỡng toàn cục)
└─ No (ánh sáng không đều)
   └─ Gradient mượt?
      ├─ Yes → Adaptive Gaussian (thích ứng Gaussian)
      └─ No → Adaptive Mean (thích ứng trung bình)
```

---

## 4. Edge Case Handling (Xử Lý Trường Hợp Đặc Biệt)

### A. Empty Frames (Khung Hình Rỗng)
```python
if frame is None or frame.size == 0:
    log_error("Nhận được khung hình rỗng")
    continue
```

### B. No Motion Detected (Không Phát Hiện Chuyển Động)
```python
if len(contours) == 0:
    # Reset tracking sau khi timeout
    cleanup_old_tracking()
    continue
```

### C. Multiple Objects (Nhiều Đối Tượng)
```python
# Theo dõi từng đối tượng riêng biệt
for contour in contours:
    object_id = assign_id(contour)
    process_object(contour, object_id)
```

### D. Occlusions (Che Khuất)
```python
# Duy trì theo dõi đối tượng ngay cả khi bị che khuất tạm thời
if object_id in tracking:
    tracking[object_id]['missing_frames'] += 1
    if tracking[object_id]['missing_frames'] > max_missing:
        del tracking[object_id]
```

---

## 5. Parameter Auto-tuning Logic (Logic Tự Động Điều Chỉnh Tham Số)

```python
def auto_tune_parameters(frame_samples):
    # Phân tích ánh sáng
    mean_brightness = np.mean(frame_samples)

    if mean_brightness < 50:  # Tối
        config.motion.threshold = 10
        config.threshold.block_size = 21
    elif mean_brightness > 200:  # Rất sáng
        config.motion.threshold = 25
        config.threshold.block_size = 11
    else:  # Bình thường
        config.motion.threshold = 16
        config.threshold.block_size = 11

    # Phân tích mức độ nhiễu
    noise_level = estimate_noise(frame_samples)
    if noise_level > threshold:
        config.morphology.kernel_size = 7
        config.morphology.iterations = 3

    return config
```

---

**Ngày tạo**: Tháng 1/2025
