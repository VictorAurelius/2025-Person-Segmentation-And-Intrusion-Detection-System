# Điều Chỉnh Tham Số

## 1. Tổng Quan

Việc điều chỉnh tham số là quan trọng để đạt hiệu suất tối ưu cho từng điều kiện cụ thể.

---

## 2. Motion Detection Parameters

### A. MOG2 Background Subtractor

```yaml
motion:
  method: "MOG2"
  history: 500          # Số frames để học background
  threshold: 16         # Độ nhạy phát hiện
  detect_shadows: true  # Phát hiện bóng đổ
```

**Hướng dẫn điều chỉnh:**

| Tình huống | history | threshold | detect_shadows |
|-----------|---------|-----------|----------------|
| Ánh sáng ổn định | 500 | 16 | true |
| Ánh sáng thay đổi | 200-300 | 25-30 | true |
| Nhiều chuyển động nhỏ | 700-1000 | 20-25 | false |
| Cần phản ứng nhanh | 100-200 | 16 | true |

### B. KNN Background Subtractor

```yaml
motion:
  method: "KNN"
  history: 500
  threshold: 400        # Khoảng cách threshold
  detect_shadows: true
```

**KNN vs MOG2:**
- KNN: Tốt hơn với nhiễu, chậm hơn
- MOG2: Nhanh hơn, nhạy với noise

### C. Frame Differencing

```yaml
motion:
  method: "FrameDiff"
  threshold: 25         # Ngưỡng khác biệt pixel
  min_contour_area: 500 # Diện tích tối thiểu
```

---

## 3. Morphological Processing

```yaml
morphology:
  kernel_size: 5        # Kích thước kernel
  iterations: 2         # Số lần lặp
```

**Hiệu quả:**

| kernel_size | iterations | Effect |
|-------------|-----------|--------|
| 3 | 1 | Giữ chi tiết, ít khử noise |
| 5 | 2 | **Cân bằng** (recommended) |
| 7 | 3 | Mất chi tiết, khử noise tốt |

**Quy tắc:**
- Nhiều noise → Tăng kernel_size
- Object nhỏ → Giảm kernel_size
- Gaps trong object → Tăng iterations

---

## 4. Adaptive Thresholding

```yaml
threshold:
  method: "Gaussian"
  block_size: 11        # Kích thước cửa sổ local
  C: 2                  # Constant trừ khỏi mean
```

**Block size guidelines:**

```
Ánh sáng thay đổi chậm? → block_size = 11-15
Ánh sáng thay đổi nhanh? → block_size = 21-31
Nhiều chi tiết nhỏ? → block_size nhỏ (7-11)
Vùng lớn đồng nhất? → block_size lớn (21-41)
```

**Lưu ý:** block_size phải là số lẻ

---

## 5. Edge Detection

```yaml
edge:
  method: "Canny"
  threshold1: 50        # Lower threshold
  threshold2: 150       # Upper threshold
  aperture_size: 3      # Sobel kernel size
```

**Canny Thresholds:**

```python
# Rule of thumb
threshold2 = 2 * threshold1  # hoặc 3 * threshold1

# Low noise
threshold1 = 50, threshold2 = 150

# High noise
threshold1 = 100, threshold2 = 200
```

---

## 6. Region Growing

```yaml
region_growing:
  threshold: 10         # Ngưỡng similarity
  connectivity: 8       # 4 hoặc 8
```

**Connectivity:**
- **4-connected**: Chỉ trên/dưới/trái/phải → vùng nhỏ hơn
- **8-connected**: + 4 góc → vùng lớn hơn

---

## 7. Intrusion Detection

```yaml
intrusion:
  overlap_threshold: 0.3    # 30% overlap
  time_threshold: 1.0       # 1 second
  min_contour_area: 500     # Pixel²
```

### A. Overlap Threshold

```
0.1 - 0.2: Rất nhạy, nhiều false positives
0.3 - 0.4: Cân bằng (recommended)
0.5 - 0.7: Ít nhạy, object phải vào sâu ROI
0.8 - 1.0: Rất khó trigger
```

### B. Time Threshold

```python
# Giảm false positives từ:
# - Chim bay qua
# - Lá cây rơi
# - Shadows ngắn hạn

time_threshold = 0.5  # Nhanh, nhiều alerts
time_threshold = 1.0  # Cân bằng
time_threshold = 2.0  # Chậm, ít alerts
```

### C. Min Contour Area

```python
# Tính toán dựa trên kích thước object tối thiểu
frame_width = 1920
frame_height = 1080
total_pixels = frame_width * frame_height

# Object chiếm 1% frame
min_area = total_pixels * 0.01  # = 20,736

# Object chiếm 0.1% frame
min_area = total_pixels * 0.001  # = 2,074
```

---

## 8. Tuning Workflow

### Step 1: Start with Defaults

```yaml
# Load cấu hình mặc định
motion:
  method: "MOG2"
  threshold: 16

intrusion:
  overlap_threshold: 0.3
  time_threshold: 1.0
```

### Step 2: Test on Sample Video

```bash
python src/main.py --config config/config.yaml --video data/input/test.mp4
```

### Step 3: Identify Issues

| Vấn đề | Nguyên nhân | Giải pháp |
|--------|-------------|-----------|
| Không phát hiện chuyển động | Threshold quá cao | Giảm motion.threshold |
| Quá nhiều false positives | Threshold quá thấp | Tăng motion.threshold |
| Object bị vỡ | Morphology yếu | Tăng kernel_size/iterations |
| Edges không rõ | Canny threshold | Điều chỉnh threshold1/2 |
| Alert liên tục | Time threshold thấp | Tăng time_threshold |

### Step 4: Iterate

```python
# Systematic tuning
for threshold in [10, 16, 20, 25, 30]:
    config.motion.threshold = threshold
    run_test()
    evaluate_results()
```

---

## 9. Environment-Specific Presets

### Daylight (Outdoor)

```yaml
motion:
  method: "MOG2"
  threshold: 20
  detect_shadows: true

threshold:
  block_size: 11
  C: 2

edge:
  threshold1: 50
  threshold2: 150
```

### Low Light (Indoor)

```yaml
motion:
  method: "KNN"
  threshold: 400
  detect_shadows: false

threshold:
  method: "Gaussian"
  block_size: 21
  C: 5

preprocessing:
  use_clahe: true
  clip_limit: 2.0
```

### Night Vision

```yaml
motion:
  method: "FrameDiff"
  threshold: 30

morphology:
  kernel_size: 7
  iterations: 3

preprocessing:
  use_clahe: true
  clip_limit: 3.0
  denoise: true
```

---

## 10. Automated Tuning

### Auto-tune Script

```python
def auto_tune(video_path, num_frames=100):
    """Tự động điều chỉnh parameters dựa trên video sample"""
    cap = cv2.VideoCapture(video_path)
    frames = []

    # Sample frames
    for _ in range(num_frames):
        ret, frame = cap.read()
        if ret:
            frames.append(frame)

    # Analyze lighting
    mean_brightness = np.mean([np.mean(f) for f in frames])

    if mean_brightness < 50:
        # Dark environment
        config.motion.threshold = 10
        config.preprocessing.use_clahe = True
    elif mean_brightness > 200:
        # Bright environment
        config.motion.threshold = 25
    else:
        # Normal
        config.motion.threshold = 16

    # Analyze noise
    noise_levels = [estimate_noise(f) for f in frames]
    avg_noise = np.mean(noise_levels)

    if avg_noise > 10:
        config.morphology.kernel_size = 7
        config.morphology.iterations = 3

    return config
```

---

## 11. Performance vs Accuracy Trade-off

```yaml
# High Performance (30+ FPS)
video:
  skip_frames: 2        # Process every 2nd frame
  resize_factor: 0.5    # Half resolution

motion:
  method: "FrameDiff"   # Fastest

morphology:
  iterations: 1         # Minimal processing
```

```yaml
# High Accuracy (<15 FPS)
video:
  skip_frames: 0        # Process all frames
  resize_factor: 1.0    # Full resolution

motion:
  method: "KNN"         # Most accurate
  history: 1000

morphology:
  kernel_size: 7
  iterations: 3

region_growing:
  enabled: true         # Additional segmentation
```

---

## 12. Validation

### Metrics

```python
# True Positives: Intrusions detected correctly
# False Positives: False alarms
# False Negatives: Missed intrusions

precision = TP / (TP + FP)
recall = TP / (TP + FN)
f1_score = 2 * (precision * recall) / (precision + recall)
```

### Test Protocol

1. Record ground truth (manual annotation)
2. Run system with parameters
3. Compare results
4. Calculate metrics
5. Adjust parameters
6. Repeat

---

**Ngày tạo**: Tháng 1/2025
