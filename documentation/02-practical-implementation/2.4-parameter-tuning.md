# Parameter Tuning (Điều Chỉnh Tham Số)

## 1. Tổng Quan

Việc điều chỉnh tham số là quan trọng để đạt hiệu suất tối ưu cho từng điều kiện cụ thể.

---

## 2. Motion Detection Parameters (Tham Số Phát Hiện Chuyển Động)

### A. MOG2 Background Subtractor (Bộ Trừ Nền MOG2)

```yaml
motion:
  method: "MOG2"
  history: 500          # Số frames để học nền
  threshold: 16         # Độ nhạy phát hiện
  detect_shadows: true  # Phát hiện bóng đổ
```

**Hướng dẫn điều chỉnh:**

| Tình huống | history | threshold | detect_shadows |
|-----------|---------|-----------|----------------|
| Ánh sáng ổn định | 500 | 16 | true |
| Ánh sáng thay đổi | 200-300 | 25-30 | true |
| Nhiều chuyển động nhỏ | 700-1000 | 20-25 | false |
| Cần phản ứng nhanh | 100-200 | 16 | true |

### B. KNN Background Subtractor (Bộ Trừ Nền KNN)

```yaml
motion:
  method: "KNN"
  history: 500
  threshold: 400        # Khoảng cách ngưỡng
  detect_shadows: true
```

**KNN vs MOG2:**
- KNN: Tốt hơn với nhiễu, chậm hơn
- MOG2: Nhanh hơn, nhạy với noise (nhiễu)

### C. Frame Differencing (Phép Trừ Khung Hình)

```yaml
motion:
  method: "FrameDiff"
  threshold: 25         # Ngưỡng khác biệt pixel
  min_contour_area: 500 # Diện tích tối thiểu
```

---

## 3. Morphological Processing (Xử Lý Hình Thái)

```yaml
morphology:
  kernel_size: 5        # Kích thước kernel
  iterations: 2         # Số lần lặp
```

**Hiệu quả:**

| kernel_size | iterations | Effect (Hiệu quả) |
|-------------|-----------|--------|
| 3 | 1 | Giữ chi tiết, ít khử nhiễu |
| 5 | 2 | **Cân bằng** (khuyến nghị) |
| 7 | 3 | Mất chi tiết, khử nhiễu tốt |

**Quy tắc:**
- Nhiều noise → Tăng kernel_size
- Object (đối tượng) nhỏ → Giảm kernel_size
- Gaps (khoảng trống) trong object → Tăng iterations

---

## 4. Adaptive Thresholding (Ngưỡng Hóa Thích Ứng)

```yaml
threshold:
  method: "Gaussian"
  block_size: 11        # Kích thước cửa sổ local
  C: 2                  # Constant (hằng số) trừ khỏi mean
```

**Block size guidelines (Hướng dẫn kích thước block):**

```
Ánh sáng thay đổi chậm? → block_size = 11-15
Ánh sáng thay đổi nhanh? → block_size = 21-31
Nhiều chi tiết nhỏ? → block_size nhỏ (7-11)
Vùng lớn đồng nhất? → block_size lớn (21-41)
```

**Lưu ý:** block_size phải là số lẻ

---

## 5. Edge Detection (Phát Hiện Cạnh)

```yaml
edge:
  method: "Canny"
  threshold1: 50        # Lower threshold (ngưỡng dưới)
  threshold2: 150       # Upper threshold (ngưỡng trên)
  aperture_size: 3      # Sobel kernel size (kích thước kernel Sobel)
```

**Canny Thresholds (Ngưỡng Canny):**

```python
# Quy tắc chung
threshold2 = 2 * threshold1  # hoặc 3 * threshold1

# Ít nhiễu
threshold1 = 50, threshold2 = 150

# Nhiều nhiễu
threshold1 = 100, threshold2 = 200
```

---

## 6. Region Growing (Tăng Trưởng Vùng)

```yaml
region_growing:
  threshold: 10         # Ngưỡng similarity (độ tương đồng)
  connectivity: 8       # 4 hoặc 8
```

**Connectivity (Liên Kết):**
- **4-connected**: Chỉ trên/dưới/trái/phải → vùng nhỏ hơn
- **8-connected**: + 4 góc → vùng lớn hơn

---

## 7. Intrusion Detection (Phát Hiện Xâm Nhập)

```yaml
intrusion:
  overlap_threshold: 0.3    # 30% chồng lấp
  time_threshold: 1.0       # 1 giây
  min_contour_area: 500     # Pixel²
```

### A. Overlap Threshold (Ngưỡng Chồng Lấp)

```
0.1 - 0.2: Rất nhạy, nhiều false positives (dương tính giả)
0.3 - 0.4: Cân bằng (khuyến nghị)
0.5 - 0.7: Ít nhạy, đối tượng phải vào sâu ROI
0.8 - 1.0: Rất khó kích hoạt
```

### B. Time Threshold (Ngưỡng Thời Gian)

```python
# Giảm false positives từ:
# - Chim bay qua
# - Lá cây rơi
# - Bóng đổ ngắn hạn

time_threshold = 0.5  # Nhanh, nhiều cảnh báo
time_threshold = 1.0  # Cân bằng
time_threshold = 2.0  # Chậm, ít cảnh báo
```

### C. Min Contour Area (Diện Tích Đường Viền Tối Thiểu)

```python
# Tính toán dựa trên kích thước đối tượng tối thiểu
frame_width = 1920
frame_height = 1080
total_pixels = frame_width * frame_height

# Đối tượng chiếm 1% khung hình
min_area = total_pixels * 0.01  # = 20,736

# Đối tượng chiếm 0.1% khung hình
min_area = total_pixels * 0.001  # = 2,074
```

---

## 8. Tuning Workflow (Quy Trình Điều Chỉnh)

### Step 1: Start with Defaults (Bắt Đầu Với Mặc Định)

```yaml
# Tải cấu hình mặc định
motion:
  method: "MOG2"
  threshold: 16

intrusion:
  overlap_threshold: 0.3
  time_threshold: 1.0
```

### Step 2: Test on Sample Video (Kiểm Tra Trên Video Mẫu)

```bash
python src/main.py --config config/config.yaml --video data/input/test.mp4
```

### Step 3: Identify Issues (Xác Định Vấn Đề)

| Vấn đề | Nguyên nhân | Giải pháp |
|--------|-------------|-----------|
| Không phát hiện chuyển động | Threshold quá cao | Giảm motion.threshold |
| Quá nhiều false positives | Threshold quá thấp | Tăng motion.threshold |
| Đối tượng bị vỡ | Morphology yếu | Tăng kernel_size/iterations |
| Cạnh không rõ | Canny threshold | Điều chỉnh threshold1/2 |
| Cảnh báo liên tục | Time threshold thấp | Tăng time_threshold |

### Step 4: Iterate (Lặp Lại)

```python
# Điều chỉnh có hệ thống
for threshold in [10, 16, 20, 25, 30]:
    config.motion.threshold = threshold
    run_test()
    evaluate_results()
```

---

## 9. Environment-Specific Presets (Cài Đặt Sẵn Theo Môi Trường)

### Daylight (Ban Ngày - Ngoài Trời)

```yaml
motion:
  method: "MOG2"
  threshold: 20
  detect_shadows: true

threshold:
  block_size: 11
  C: 2

edge:
  threshold1: 50
  threshold2: 150
```

### Low Light (Ánh Sáng Yếu - Trong Nhà)

```yaml
motion:
  method: "KNN"
  threshold: 400
  detect_shadows: false

threshold:
  method: "Gaussian"
  block_size: 21
  C: 5

preprocessing:
  use_clahe: true
  clip_limit: 2.0
```

### Night Vision (Tầm Nhìn Ban Đêm)

```yaml
motion:
  method: "FrameDiff"
  threshold: 30

morphology:
  kernel_size: 7
  iterations: 3

preprocessing:
  use_clahe: true
  clip_limit: 3.0
  denoise: true
```

---

## 10. Automated Tuning (Điều Chỉnh Tự Động)

### Auto-tune Script (Kịch Bản Tự Động Điều Chỉnh)

```python
def auto_tune(video_path, num_frames=100):
    """Tự động điều chỉnh tham số dựa trên video mẫu"""
    cap = cv2.VideoCapture(video_path)
    frames = []

    # Lấy mẫu khung hình
    for _ in range(num_frames):
        ret, frame = cap.read()
        if ret:
            frames.append(frame)

    # Phân tích ánh sáng
    mean_brightness = np.mean([np.mean(f) for f in frames])

    if mean_brightness < 50:
        # Môi trường tối
        config.motion.threshold = 10
        config.preprocessing.use_clahe = True
    elif mean_brightness > 200:
        # Môi trường sáng
        config.motion.threshold = 25
    else:
        # Bình thường
        config.motion.threshold = 16

    # Phân tích nhiễu
    noise_levels = [estimate_noise(f) for f in frames]
    avg_noise = np.mean(noise_levels)

    if avg_noise > 10:
        config.morphology.kernel_size = 7
        config.morphology.iterations = 3

    return config
```

---

## 11. Performance vs Accuracy Trade-off (Đánh Đổi Hiệu Năng vs Độ Chính Xác)

```yaml
# High Performance (Hiệu năng cao - 30+ FPS)
video:
  skip_frames: 2        # Xử lý mỗi khung hình thứ 2
  resize_factor: 0.5    # Nửa độ phân giải

motion:
  method: "FrameDiff"   # Nhanh nhất

morphology:
  iterations: 1         # Xử lý tối thiểu
```

```yaml
# High Accuracy (Độ chính xác cao - <15 FPS)
video:
  skip_frames: 0        # Xử lý tất cả khung hình
  resize_factor: 1.0    # Độ phân giải đầy đủ

motion:
  method: "KNN"         # Chính xác nhất
  history: 1000

morphology:
  kernel_size: 7
  iterations: 3

region_growing:
  enabled: true         # Phân vùng bổ sung
```

---

## 12. Validation (Xác Thực)

### Metrics (Chỉ Số)

```python
# True Positives: Xâm nhập được phát hiện chính xác
# False Positives: Cảnh báo sai
# False Negatives: Xâm nhập bị bỏ lỡ

precision = TP / (TP + FP)
recall = TP / (TP + FN)
f1_score = 2 * (precision * recall) / (precision + recall)
```

### Test Protocol (Quy Trình Kiểm Tra)

1. Ghi lại ground truth (chân lý) (chú thích thủ công)
2. Chạy hệ thống với tham số
3. So sánh kết quả
4. Tính toán chỉ số
5. Điều chỉnh tham số
6. Lặp lại

---

**Ngày tạo**: Tháng 1/2025
