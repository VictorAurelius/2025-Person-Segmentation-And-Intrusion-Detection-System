# Performance Metrics (Chỉ Số Hiệu Năng)

## 1. Tổng Quan

Hệ thống được đánh giá qua 3 nhóm chỉ số chính: Detection Quality (chất lượng phát hiện), Performance (hiệu năng), và System Reliability (độ tin cậy hệ thống).

---

## 2. Detection Quality Metrics (Chỉ Số Chất Lượng Phát Hiện)

### A. Confusion Matrix (Ma Trận Nhầm Lẫn)

```
                  Predicted (Dự Đoán)
              Positive  Negative
Actual  Pos     TP        FN
(Thực)  Neg     FP        TN
```

**Định nghĩa:**
- **True Positive (TP - dương thật)**: Phát hiện đúng xâm nhập
- **False Positive (FP - dương giả)**: Phát hiện nhầm (cảnh báo sai)
- **False Negative (FN - âm giả)**: Bỏ sót xâm nhập
- **True Negative (TN - âm thật)**: Đúng không có xâm nhập

### B. Precision (Độ Chính Xác Dương)

```python
Precision = TP / (TP + FP)
```

**Ý nghĩa:** Tỷ lệ cảnh báo chính xác

**Ví dụ:**
```
TP = 95 (phát hiện đúng)
FP = 5 (cảnh báo sai)
Precision = 95 / (95 + 5) = 95%
```

**Đánh giá:**
- >95%: Xuất sắc
- 85-95%: Tốt
- 70-85%: Chấp nhận được
- <70%: Kém

### C. Recall/Sensitivity (Độ Phủ/Độ Nhạy)

```python
Recall = TP / (TP + FN)
```

**Ý nghĩa:** Tỷ lệ xâm nhập được phát hiện

**Ví dụ:**
```
TP = 95 (phát hiện đúng)
FN = 5 (bỏ sót xâm nhập)
Recall = 95 / (95 + 5) = 95%
```

**Đánh giá:**
- >95%: Xuất sắc
- 85-95%: Tốt
- 70-85%: Chấp nhận được
- <70%: Kém

### D. F1-Score (Điểm F1)

```python
F1 = 2 * (Precision * Recall) / (Precision + Recall)
```

**Ý nghĩa:** Trung bình điều hòa của Precision và Recall

**Ví dụ:**
```
Precision = 95%
Recall = 95%
F1 = 2 * (0.95 * 0.95) / (0.95 + 0.95) = 95%
```

**Đánh giá:**
- >90%: Xuất sắc
- 80-90%: Tốt
- 65-80%: Chấp nhận được
- <65%: Kém

### E. Specificity (Độ Đặc Hiệu)

```python
Specificity = TN / (TN + FP)
```

**Ý nghĩa:** Tỷ lệ không có xâm nhập được xác định đúng

---

## 3. Performance Metrics (Chỉ Số Hiệu Năng)

### A. Frames Per Second - FPS (Số Khung Hình Mỗi Giây)

```python
FPS = Total Frames / Total Time
```

**Đo lường:**
```python
import time

start = time.time()
frame_count = 0

while processing:
    process_frame()
    frame_count += 1

end = time.time()
fps = frame_count / (end - start)
```

**Tiêu chuẩn:**
- Thời gian thực: >25 FPS
- Chấp nhận được: 15-25 FPS
- Chậm: <15 FPS

### B. Processing Time per Frame (Thời Gian Xử Lý Mỗi Khung)

```python
avg_time = total_processing_time / total_frames
```

**Phân tích chi tiết:**
```
Motion Detection (Phát hiện chuyển động):    15ms (40%)
Morphology (Hình thái học):                  8ms  (20%)
Contour Detection (Phát hiện đường viền):    7ms  (18%)
Intrusion Check (Kiểm tra xâm nhập):         5ms  (13%)
Drawing/Display (Vẽ/Hiển thị):               3ms  (8%)
Total (Tổng):                               38ms  (100%)
```

**Mục tiêu:** <40ms per frame (25 FPS)

### C. Latency (Độ Trễ)

```python
latency = time_detected - time_occurred
```

**Đo lường:**
```python
frame_timestamp = frame_number / video_fps
detection_timestamp = time.time()
latency = detection_timestamp - frame_timestamp
```

**Yêu cầu:**
- Cảnh báo nghiêm trọng: <200ms
- Cảnh báo thường: <500ms
- Xử lý hàng loạt: <1000ms

### D. Memory Usage (Sử Dụng Bộ Nhớ)

```python
import psutil

process = psutil.Process()
memory_mb = process.memory_info().rss / 1024 / 1024
```

**Theo dõi:**
```
Initial (Ban đầu): 150 MB
After 1 hour (Sau 1 giờ): 180 MB
After 24 hours (Sau 24 giờ): 200 MB
Memory leak rate (Tốc độ rò rỉ bộ nhớ): ~2 MB/hour
```

**Ngưỡng:**
- Thấp: <200 MB
- Trung bình: 200-500 MB
- Cao: >500 MB

### E. CPU Usage (Sử Dụng CPU)

```python
cpu_percent = psutil.cpu_percent(interval=1)
```

**Theo module:**
```
Motion Detection (Phát hiện chuyển động): 35%
Image Processing (Xử lý ảnh): 25%
Contour Analysis (Phân tích đường viền): 15%
Alert System (Hệ thống cảnh báo): 5%
Overhead (Chi phí hệ thống): 20%
Total (Tổng): 100% of available CPU
```

---

## 4. Accuracy Metrics (Chỉ Số Độ Chính Xác)

### A. Intersection over Union - IoU (Giao trên Hợp)

```python
def calculate_iou(box1, box2):
    """Tính IoU giữa hai bounding boxes"""
    x1 = max(box1[0], box2[0])
    y1 = max(box1[1], box2[1])
    x2 = min(box1[2], box2[2])
    y2 = min(box1[3], box2[3])

    intersection = max(0, x2 - x1) * max(0, y2 - y1)
    area1 = (box1[2] - box1[0]) * (box1[3] - box1[1])
    area2 = (box2[2] - box2[0]) * (box2[3] - box2[1])
    union = area1 + area2 - intersection

    return intersection / union
```

**Sử dụng:** So sánh bounding box phát hiện được với ground truth

**Ngưỡng:**
- IoU > 0.7: Khớp tốt
- IoU 0.5-0.7: Chấp nhận được
- IoU < 0.5: Khớp kém

### B. Detection Accuracy by Object Size (Độ Chính Xác Theo Kích Thước Đối Tượng)

```python
# Small objects (Đối tượng nhỏ - < 1% frame)
small_objects_accuracy = TP_small / (TP_small + FN_small)

# Medium objects (Đối tượng trung bình - 1-5% frame)
medium_objects_accuracy = TP_medium / (TP_medium + FN_medium)

# Large objects (Đối tượng lớn - > 5% frame)
large_objects_accuracy = TP_large / (TP_large + FN_large)
```

**Kỳ vọng:**
- Lớn: >95%
- Trung bình: >85%
- Nhỏ: >70%

### C. Temporal Consistency (Tính Nhất Quán Theo Thời Gian)

```python
def temporal_consistency(detections):
    """Đo tính ổn định của phát hiện theo thời gian"""
    gaps = []
    for i in range(len(detections) - 1):
        if detections[i]['object_id'] == detections[i+1]['object_id']:
            gap = detections[i+1]['frame'] - detections[i]['frame']
            gaps.append(gap)

    avg_gap = np.mean(gaps)
    return 1.0 / avg_gap  # Khoảng cách nhỏ hơn = tính nhất quán cao hơn
```

---

## 5. System Reliability Metrics (Chỉ Số Độ Tin Cậy Hệ Thống)

### A. Uptime (Thời Gian Hoạt Động)

```python
uptime_percent = (total_time - downtime) / total_time * 100
```

**Mục tiêu:** >99.5% uptime

### B. Mean Time Between Failures - MTBF (Thời Gian Trung Bình Giữa Các Lỗi)

```python
MTBF = total_operating_time / number_of_failures
```

**Ví dụ:**
```
Operating time (Thời gian hoạt động): 720 hours (30 days)
Failures (Lỗi): 2
MTBF = 720 / 2 = 360 hours
```

**Mục tiêu:** >500 hours

### C. Mean Time To Recovery - MTTR (Thời Gian Trung Bình Để Khôi Phục)

```python
MTTR = total_recovery_time / number_of_failures
```

**Ví dụ:**
```
Failure 1: 5 minutes to restart
Failure 2: 3 minutes to restart
MTTR = (5 + 3) / 2 = 4 minutes
```

**Mục tiêu:** <10 minutes

### D. Error Rate (Tỷ Lệ Lỗi)

```python
error_rate = errors / total_frames_processed
```

**Phân loại:**
- Lỗi nghiêm trọng (crashes): 0%
- Lỗi xử lý: <0.1%
- Thông báo cảnh báo: <1%

---

## 6. Alert Quality Metrics (Chỉ Số Chất Lượng Cảnh Báo)

### A. Alert Precision (Độ Chính Xác Cảnh Báo)

```python
alert_precision = valid_alerts / total_alerts
```

**Mục tiêu:** >90%

### B. Alert Response Time (Thời Gian Phản Hồi Cảnh Báo)

```python
response_time = alert_triggered_time - intrusion_start_time
```

**Thành phần:**
1. Detection time (Thời gian phát hiện): <200ms
2. Validation time (Thời gian xác thực): <300ms
3. Alert generation (Tạo cảnh báo): <100ms
**Total (Tổng):** <600ms

### C. Alert Cooldown Effectiveness (Hiệu Quả Thời Gian Chờ Cảnh Báo)

```python
duplicate_rate = duplicate_alerts / total_alerts
```

**Mục tiêu:** <5% duplicate alerts

---

## 7. Comparative Metrics (Chỉ Số So Sánh)

### A. Method Comparison (So Sánh Phương Pháp)

| Method | Precision | Recall | F1 | FPS |
|--------|-----------|--------|-----|-----|
| MOG2 | 92% | 90% | 91% | 28 |
| KNN | 90% | 93% | 91.5% | 22 |
| FrameDiff | 85% | 88% | 86.5% | 35 |

### B. Configuration Comparison (So Sánh Cấu Hình)

| Cấu Hình | Ban Ngày | Ban Đêm | Ánh Sáng Thay Đổi |
|----------|-----------|----------|-------------------|
| Mặc định | 91% | 65% | 78% |
| Tối ưu | 93% | 78% | 85% |

---

## 8. Metric Collection (Thu Thập Chỉ Số)

### A. Automated Logging (Ghi Log Tự Động)

```python
class MetricsCollector:
    """Thu thập và tính toán các chỉ số hiệu năng"""
    def __init__(self):
        self.metrics = {
            'frames_processed': 0,
            'true_positives': 0,
            'false_positives': 0,
            'false_negatives': 0,
            'processing_times': [],
            'memory_samples': []
        }

    def log_detection(self, is_intrusion, is_correct):
        """Ghi log kết quả phát hiện"""
        self.metrics['frames_processed'] += 1
        if is_intrusion and is_correct:
            self.metrics['true_positives'] += 1
        elif is_intrusion and not is_correct:
            self.metrics['false_positives'] += 1
        elif not is_intrusion and not is_correct:
            self.metrics['false_negatives'] += 1

    def calculate_metrics(self):
        """Tính toán các chỉ số"""
        tp = self.metrics['true_positives']
        fp = self.metrics['false_positives']
        fn = self.metrics['false_negatives']

        precision = tp / (tp + fp) if (tp + fp) > 0 else 0
        recall = tp / (tp + fn) if (tp + fn) > 0 else 0
        f1 = 2 * (precision * recall) / (precision + recall) if (precision + recall) > 0 else 0

        return {
            'precision': precision,
            'recall': recall,
            'f1_score': f1,
            'avg_processing_time': np.mean(self.metrics['processing_times'])
        }
```

### B. Real-time Dashboard (Bảng Điều Khiển Thời Gian Thực)

```python
def display_metrics(metrics):
    """Hiển thị các chỉ số thời gian thực trên frame"""
    text = [
        f"FPS: {metrics['fps']:.1f}",
        f"Precision: {metrics['precision']:.2%}",
        f"Recall: {metrics['recall']:.2%}",
        f"Alerts: {metrics['total_alerts']}"
    ]

    y_offset = 30
    for line in text:
        cv2.putText(frame, line, (10, y_offset),
                   cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 0), 2)
        y_offset += 30
```

---

## 9. Benchmark Standards (Tiêu Chuẩn Đánh Giá)

### Tiêu Chuẩn Ngành

```yaml
# PETS Dataset Benchmark
minimum_detection_rate: 0.85
maximum_false_alarm_rate: 0.15

# VIRAT Dataset Benchmark
precision_threshold: 0.80
recall_threshold: 0.85
```

### Mục Tiêu Dự Án

```yaml
# Easy scenarios (Kịch bản dễ - daylight, clean background)
target_precision: 0.95
target_recall: 0.95
target_fps: 25

# Medium scenarios (Kịch bản trung bình - indoor, multiple objects)
target_precision: 0.85
target_recall: 0.85
target_fps: 20

# Hard scenarios (Kịch bản khó - night, weather)
target_precision: 0.70
target_recall: 0.75
target_fps: 15
```

---

## 10. Report Generation (Tạo Báo Cáo)

### A. Summary Report (Báo Cáo Tóm Tắt)

```python
def generate_summary_report(metrics):
    """Tạo báo cáo tóm tắt hiệu năng"""
    report = f"""
    ================================
    HỆ THỐNG PHÁT HIỆN XÂM NHẬP
    BÁO CÁO HIỆU NĂNG
    ================================

    Chất Lượng Phát Hiện:
    - Precision:    {metrics['precision']:.2%}
    - Recall:       {metrics['recall']:.2%}
    - F1-Score:     {metrics['f1_score']:.2%}

    Hiệu Năng:
    - Average FPS:  {metrics['fps']:.1f}
    - Latency:      {metrics['latency']:.0f}ms

    Độ Tin Cậy:
    - Uptime:       {metrics['uptime']:.2%}
    - Error Rate:   {metrics['error_rate']:.4%}

    Thống Kê Tổng:
    - Frames:       {metrics['total_frames']:,}
    - Intrusions:   {metrics['total_intrusions']}
    - Alerts:       {metrics['total_alerts']}
    """
    return report
```

### B. Detailed CSV Export (Xuất CSV Chi Tiết)

```python
import csv

def export_detailed_metrics(metrics, filename):
    """Xuất các chỉ số chi tiết ra file CSV"""
    with open(filename, 'w', newline='') as f:
        writer = csv.writer(f)
        writer.writerow(['Timestamp', 'Frame', 'Detection', 'Processing Time', 'Memory'])

        for record in metrics['detailed_records']:
            writer.writerow([
                record['timestamp'],
                record['frame_number'],
                record['detection_result'],
                record['processing_time'],
                record['memory_usage']
            ])
```

---

**Ngày tạo**: Tháng 1/2025
