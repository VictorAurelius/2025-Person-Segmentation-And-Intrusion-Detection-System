# Test Scenarios (Kịch Bản Kiểm Thử)

## 1. Tổng Quan

Hệ thống được kiểm thử với nhiều kịch bản khác nhau để đánh giá hiệu suất trong các điều kiện thực tế.

---

## 2. Ma Trận Kịch Bản Kiểm Thử

| Kịch Bản | Ánh Sáng | Môi Trường | Loại Chuyển Động | Độ Khó |
|----------|----------|-------------|-------------|------------|
| S1 | Ban ngày | Ngoài trời | Người đi bộ | Dễ |
| S2 | Ánh sáng nhân tạo trong nhà | Văn phòng | Nhiều người | Trung bình |
| S3 | Ánh sáng yếu | Buổi tối | Người chạy | Trung bình |
| S4 | Ban đêm | Đường tối | Xe cộ | Khó |
| S5 | Thay đổi | Ngoài trời có mây | Người + gió | Khó |
| S6 | Ngược sáng | Cửa sổ sau đối tượng | Người | Khó |
| S7 | Bóng đổ | Mặt trời buổi trưa | Người có bóng | Trung bình |
| S8 | Mưa | Ngoài trời ẩm ướt | Người cầm ô | Khó |

**Chú thích:** Ma trận phân loại các kịch bản theo ánh sáng, môi trường, loại chuyển động và độ khó

---

## 3. Chi Tiết Từng Kịch Bản

### Kịch Bản 1: Ban Ngày Ngoài Trời

**Điều kiện:**
- Thời gian: 10:00 AM - 3:00 PM
- Ánh sáng: Mặt trời, ổn định
- Background (nền): Tĩnh (tường, đường)
- Object (đối tượng): 1 người đi bộ

**Cấu hình:**
```yaml
motion:
  method: "MOG2"
  threshold: 20
  detect_shadows: true

intrusion:
  overlap_threshold: 0.3
  time_threshold: 1.0
```

**Kết quả mong đợi:**
- Detection rate (tỷ lệ phát hiện): >95%
- False positive rate (tỷ lệ cảnh báo nhầm): <5%
- FPS (khung hình/giây): >25

---

### Kịch Bản 2: Trong Nhà Nhiều Đối Tượng

**Điều kiện:**
- Thời gian: Bất kỳ
- Ánh sáng: Đèn huỳnh quang, ổn định
- Background (nền): Bàn ghế, cửa
- Objects (đối tượng): 2-5 người di chuyển đồng thời

**Thử thách:**
- Occlusion (che khuất - người che người)
- Multiple tracking (theo dõi nhiều đối tượng)
- Similar appearances (ngoại hình tương tự)

**Cấu hình:**
```yaml
motion:
  method: "KNN"
  threshold: 400
  history: 700

intrusion:
  min_contour_area: 800
  overlap_threshold: 0.4
```

**Kết quả mong đợi:**
- Detection rate (tỷ lệ phát hiện): >85%
- False positive rate (tỷ lệ cảnh báo nhầm): <10%
- Correct tracking (theo dõi chính xác): >80%

---

### Kịch Bản 3: Chiều Tối Ánh Sáng Yếu

**Điều kiện:**
- Thời gian: 6:00 PM - 8:00 PM
- Ánh sáng: Hoàng hôn, giảm dần
- Background (nền): Ngoài trời
- Object (đối tượng): 1 người chạy

**Thử thách:**
- Ánh sáng thay đổi liên tục
- Contrast (độ tương phản) thấp
- Fast motion (chuyển động nhanh)

**Cấu hình:**
```yaml
preprocessing:
  use_clahe: true
  clip_limit: 2.0

motion:
  method: "MOG2"
  threshold: 15
  history: 300

intrusion:
  time_threshold: 0.5  # Chạy nhanh
```

**Kết quả mong đợi:**
- Detection rate (tỷ lệ phát hiện): >75%
- False positive rate (tỷ lệ cảnh báo nhầm): <15%
- Latency (độ trễ): <500ms

---

### Kịch Bản 4: Tầm Nhìn Ban Đêm

**Điều kiện:**
- Thời gian: 10:00 PM - 5:00 AM
- Ánh sáng: Rất tối, có thể có đèn đường
- Background (nền): Đường phố
- Object (đối tượng): Xe ô tô/xe máy

**Thử thách:**
- Noise (nhiễu) cao
- Contrast (độ tương phản) rất thấp
- Fast moving objects (vật thể chuyển động nhanh)
- Headlights glare (chói đèn pha)

**Cấu hình:**
```yaml
preprocessing:
  use_clahe: true
  clip_limit: 3.0
  denoise: true

motion:
  method: "FrameDiff"
  threshold: 30

morphology:
  kernel_size: 7
  iterations: 3

intrusion:
  min_contour_area: 2000  # Xe lớn hơn người
```

**Kết quả mong đợi:**
- Detection rate (tỷ lệ phát hiện): >60%
- False positive rate (tỷ lệ cảnh báo nhầm): <20%
- Miss large objects (bỏ sót vật lớn): <10%

---

### Kịch Bản 5: Ánh Sáng Thay Đổi

**Điều kiện:**
- Thời gian: Trời nhiều mây
- Ánh sáng: Thay đổi đột ngột (mây che/mở)
- Background (nền): Cây cối lắc (gió)
- Object (đối tượng): Người đi bộ

**Thử thách:**
- Ánh sáng không ổn định
- Background motion (chuyển động nền - gió)
- False motion from shadows (chuyển động giả từ bóng)

**Cấu hình:**
```yaml
motion:
  method: "MOG2"
  threshold: 25
  detect_shadows: true
  history: 300  # Thích ứng nhanh

morphology:
  kernel_size: 5
  iterations: 2

intrusion:
  time_threshold: 1.5  # Giảm false positives
```

**Kết quả mong đợi:**
- Detection rate (tỷ lệ phát hiện): >70%
- False positive rate (tỷ lệ cảnh báo nhầm): <25%
- Adapt to lighting (thích ứng ánh sáng): <5 giây

---

### Kịch Bản 6: Ngược Sáng

**Điều kiện:**
- Camera nhìn về phía cửa sổ/nguồn sáng
- Object (đối tượng) trở thành silhouette (bóng tối)
- High contrast (độ tương phản cao)
- Object (đối tượng): Người đi qua cửa

**Thử thách:**
- Object detail loss (mất chi tiết đối tượng)
- Glare from light source (chói từ nguồn sáng)
- Overexposure (quá sáng)

**Cấu hình:**
```yaml
preprocessing:
  use_histogram_equalization: true

threshold:
  method: "Otsu"  # Tốt hơn cho bimodal histogram

edge:
  method: "Canny"
  threshold1: 30
  threshold2: 90
```

**Kết quả mong đợi:**
- Detection rate (tỷ lệ phát hiện): >65%
- Silhouette detection (phát hiện bóng tối): >85%
- False positive rate (tỷ lệ cảnh báo nhầm): <20%

---

### Kịch Bản 7: Bóng Mạnh

**Điều kiện:**
- Thời gian: 12:00 PM (mặt trời cao)
- Object (đối tượng) tạo bóng mạnh
- Shadow (bóng) di chuyển cùng đối tượng

**Thử thách:**
- Shadow (bóng) bị phát hiện như đối tượng
- Shadow overlap (bóng chồng lên) ROI
- Multiple contours (nhiều đường viền) cho mỗi đối tượng

**Cấu hình:**
```yaml
motion:
  method: "MOG2"
  detect_shadows: true  # Loại bỏ shadows
  shadow_threshold: 127

morphology:
  kernel_size: 5
  iterations: 2  # Gộp object + shadow
```

**Kết quả mong đợi:**
- Correct shadow removal (loại bỏ bóng đúng): >80%
- Object detection (phát hiện đối tượng): >90%
- False positive from shadows (cảnh báo nhầm từ bóng): <10%

---

### Kịch Bản 8: Điều Kiện Thời Tiết

**Điều kiện:**
- Mưa hoặc tuyết
- Giọt nước trên lens (ống kính)
- Reduced visibility (tầm nhìn giảm)
- Object (đối tượng): Người cầm ô

**Thử thách:**
- Rain drops (giọt mưa) được phát hiện như chuyển động
- Blur (mờ) và noise (nhiễu)
- Object (đối tượng) bị che một phần bởi ô

**Cấu hình:**
```yaml
preprocessing:
  denoise: true
  blur_kernel: 5

motion:
  method: "KNN"
  threshold: 500  # Ít nhạy cảm hơn

morphology:
  kernel_size: 7
  iterations: 3

intrusion:
  min_contour_area: 1000  # Lọc giọt mưa nhỏ
  time_threshold: 2.0
```

**Kết quả mong đợi:**
- Detection rate (tỷ lệ phát hiện): >50%
- False positive from rain (cảnh báo nhầm từ mưa): <30%
- System stability (độ ổn định hệ thống): Không có crashes

---

## 4. Chuẩn Bị Dữ Liệu Kiểm Thử

### A. Thu Thập Video

```bash
# Cấu trúc thư mục
data/test-videos/
├── scenario-1/
│   ├── test1.mp4
│   ├── test2.mp4
│   └── ground_truth.json
├── scenario-2/
│   ├── test1.mp4
│   └── ground_truth.json
...
```

### B. Chú Thích Ground Truth (Dữ Liệu Chuẩn)

```json
{
  "video": "scenario-1/test1.mp4",
  "annotations": [
    {
      "frame": 120,
      "timestamp": 4.0,
      "intrusion": true,
      "roi": "Entrance",
      "bbox": [100, 200, 150, 300]
    },
    {
      "frame": 350,
      "timestamp": 11.67,
      "intrusion": false,
      "note": "Object outside ROI"
    }
  ]
}
```

### C. Script Kiểm Thử Tự Động

```python
def run_test_scenario(scenario_name, config_path):
    """Chạy kiểm thử cho một kịch bản cụ thể"""

    # Tải test videos và ground truth
    videos = load_test_videos(scenario_name)
    ground_truth = load_ground_truth(scenario_name)

    results = []

    for video_path in videos:
        # Chạy hệ thống phát hiện
        detections = run_detection(video_path, config_path)

        # So sánh với ground truth
        metrics = evaluate_detections(detections, ground_truth)

        results.append({
            'video': video_path,
            'precision': metrics['precision'],
            'recall': metrics['recall'],
            'f1_score': metrics['f1_score'],
            'fps': metrics['fps']
        })

    # Tạo báo cáo
    generate_report(scenario_name, results)

    return results
```

---

## 5. Kế Hoạch Thực Thi Kiểm Thử

### Giai Đoạn 1: Kịch Bản Cơ Bản (Tuần 1)
```bash
# Chạy các kịch bản dễ trước
python test/run_scenario.py --scenario S1
python test/run_scenario.py --scenario S2
```

### Giai Đoạn 2: Điều Kiện Thách Thức (Tuần 2)
```bash
python test/run_scenario.py --scenario S3
python test/run_scenario.py --scenario S4
python test/run_scenario.py --scenario S5
```

### Giai Đoạn 3: Trường Hợp Đặc Biệt (Tuần 3)
```bash
python test/run_scenario.py --scenario S6
python test/run_scenario.py --scenario S7
python test/run_scenario.py --scenario S8
```

### Giai Đoạn 4: Kiểm Thử Toàn Diện (Tuần 4)
```bash
# Chạy tất cả kịch bản
python test/run_all_scenarios.py

# Tạo báo cáo toàn diện
python test/generate_report.py --all
```

---

## 6. Tiêu Chí Thành Công

| Chỉ Số | Dễ | Trung Bình | Khó |
|--------|------|--------|------|
| Precision (độ chính xác dương) | >90% | >80% | >60% |
| Recall (độ phủ) | >95% | >85% | >70% |
| F1-Score (điểm F1) | >92% | >82% | >65% |
| FPS (khung hình/giây) | >25 | >20 | >15 |
| Latency (độ trễ) | <200ms | <300ms | <500ms |

---

## 7. Mẫu Báo Cáo Kiểm Thử

```markdown
# Báo Cáo Kiểm Thử: Kịch Bản X

## Cấu Hình
- Ngày: YYYY-MM-DD
- Hệ thống: [Thông số phần cứng]
- Phần mềm: [Phiên bản]

## Kết Quả
- Tổng số khung hình: 1000
- True positives (dương tính thật): 45
- False positives (dương tính giả): 5
- False negatives (âm tính giả): 3
- Precision (độ chính xác): 90%
- Recall (độ phủ): 93.75%
- F1-Score (điểm F1): 91.8%

## Hiệu Năng
- FPS trung bình: 27.3
- FPS tối thiểu: 22.1
- FPS tối đa: 30.0
- Độ trễ trung bình: 180ms

## Vấn Đề Phát Hiện
1. False positive khi cành cây di chuyển
2. Bỏ sót phát hiện khi người bị che khuất một phần

## Khuyến Nghị
- Tăng time_threshold lên 1.5s
- Thêm region growing để phân vùng tốt hơn
```

---

**Ngày tạo**: Tháng 1/2025
