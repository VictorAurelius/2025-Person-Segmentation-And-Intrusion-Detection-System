# Kịch Bản Kiểm Thử

## 1. Tổng Quan

Hệ thống được kiểm thử với nhiều kịch bản khác nhau để đánh giá hiệu suất trong các điều kiện thực tế.

---

## 2. Test Scenarios Matrix

| Scenario | Lighting | Environment | Motion Type | Difficulty |
|----------|----------|-------------|-------------|------------|
| S1 | Daylight | Outdoor | Walking person | Easy |
| S2 | Indoor artificial | Office | Multiple people | Medium |
| S3 | Low light | Evening | Running person | Medium |
| S4 | Night | Dark street | Vehicle | Hard |
| S5 | Variable | Outdoor with clouds | Person + wind | Hard |
| S6 | Backlight | Window behind object | Person | Hard |
| S7 | Shadows | Midday sun | Person casting shadow | Medium |
| S8 | Rain | Outdoor wet | Person with umbrella | Hard |

---

## 3. Chi Tiết Từng Scenario

### Scenario 1: Daylight Outdoor

**Điều kiện:**
- Thời gian: 10:00 AM - 3:00 PM
- Ánh sáng: Mặt trời, ổn định
- Background: Tĩnh (tường, đường)
- Object: 1 người đi bộ

**Cấu hình:**
```yaml
motion:
  method: "MOG2"
  threshold: 20
  detect_shadows: true

intrusion:
  overlap_threshold: 0.3
  time_threshold: 1.0
```

**Kết quả mong đợi:**
- Detection rate: >95%
- False positive rate: <5%
- FPS: >25

---

### Scenario 2: Indoor Multiple Objects

**Điều kiện:**
- Thời gian: Bất kỳ
- Ánh sáng: Đèn huỳnh quang, ổn định
- Background: Bàn ghế, cửa
- Objects: 2-5 người di chuyển đồng thời

**Thử thách:**
- Occlusion (người che người)
- Multiple tracking
- Similar appearances

**Cấu hình:**
```yaml
motion:
  method: "KNN"
  threshold: 400
  history: 700

intrusion:
  min_contour_area: 800
  overlap_threshold: 0.4
```

**Kết quả mong đợi:**
- Detection rate: >85%
- False positive rate: <10%
- Correct tracking: >80%

---

### Scenario 3: Low Light Evening

**Điều kiện:**
- Thời gian: 6:00 PM - 8:00 PM
- Ánh sáng: Hoàng hôn, giảm dần
- Background: Ngoài trời
- Object: 1 người chạy

**Thử thách:**
- Ánh sáng thay đổi liên tục
- Contrast thấp
- Fast motion

**Cấu hình:**
```yaml
preprocessing:
  use_clahe: true
  clip_limit: 2.0

motion:
  method: "MOG2"
  threshold: 15
  history: 300

intrusion:
  time_threshold: 0.5  # Chạy nhanh
```

**Kết quả mong đợi:**
- Detection rate: >75%
- False positive rate: <15%
- Latency: <500ms

---

### Scenario 4: Night Vision

**Điều kiện:**
- Thời gian: 10:00 PM - 5:00 AM
- Ánh sáng: Rất tối, có thể có đèn đường
- Background: Đường phố
- Object: Xe ô tô/xe máy

**Thử thách:**
- Noise cao
- Contrast rất thấp
- Fast moving objects
- Headlights glare

**Cấu hình:**
```yaml
preprocessing:
  use_clahe: true
  clip_limit: 3.0
  denoise: true

motion:
  method: "FrameDiff"
  threshold: 30

morphology:
  kernel_size: 7
  iterations: 3

intrusion:
  min_contour_area: 2000  # Xe lớn hơn người
```

**Kết quả mong đợi:**
- Detection rate: >60%
- False positive rate: <20%
- Miss large objects: <10%

---

### Scenario 5: Variable Lighting

**Điều kiện:**
- Thời gian: Trời nhiều mây
- Ánh sáng: Thay đổi đột ngột (mây che/mở)
- Background: Cây cối lắc (gió)
- Object: Người đi bộ

**Thử thách:**
- Ánh sáng không ổn định
- Background motion (wind)
- False motion from shadows

**Cấu hình:**
```yaml
motion:
  method: "MOG2"
  threshold: 25
  detect_shadows: true
  history: 300  # Adapt nhanh

morphology:
  kernel_size: 5
  iterations: 2

intrusion:
  time_threshold: 1.5  # Reduce false positives
```

**Kết quả mong đợi:**
- Detection rate: >70%
- False positive rate: <25%
- Adapt to lighting: <5 seconds

---

### Scenario 6: Backlighting

**Điều kiện:**
- Camera nhìn về phía cửa sổ/nguồn sáng
- Object trở thành silhouette
- High contrast
- Object: Người đi qua cửa

**Thử thách:**
- Object detail loss
- Glare from light source
- Overexposure

**Cấu hình:**
```yaml
preprocessing:
  use_histogram_equalization: true

threshold:
  method: "Otsu"  # Better for bimodal histogram

edge:
  method: "Canny"
  threshold1: 30
  threshold2: 90
```

**Kết quả mong đợi:**
- Detection rate: >65%
- Silhouette detection: >85%
- False positive rate: <20%

---

### Scenario 7: Strong Shadows

**Điều kiện:**
- Thời gian: 12:00 PM (mặt trời cao)
- Object casting strong shadow
- Shadow moves with object

**Thử thách:**
- Shadow detected as object
- Shadow overlap with ROI
- Multiple contours per object

**Cấu hình:**
```yaml
motion:
  method: "MOG2"
  detect_shadows: true  # Loại bỏ shadows
  shadow_threshold: 127

morphology:
  kernel_size: 5
  iterations: 2  # Merge object + shadow
```

**Kết quả mong đợi:**
- Correct shadow removal: >80%
- Object detection: >90%
- False positive from shadows: <10%

---

### Scenario 8: Weather Conditions

**Điều kiện:**
- Mưa hoặc tuyết
- Giọt nước trên lens
- Reduced visibility
- Object: Người cầm ô

**Thử thách:**
- Rain drops detected as motion
- Blur and noise
- Object partially occluded by umbrella

**Cấu hình:**
```yaml
preprocessing:
  denoise: true
  blur_kernel: 5

motion:
  method: "KNN"
  threshold: 500  # Less sensitive

morphology:
  kernel_size: 7
  iterations: 3

intrusion:
  min_contour_area: 1000  # Filter small rain drops
  time_threshold: 2.0
```

**Kết quả mong đợi:**
- Detection rate: >50%
- False positive from rain: <30%
- System stability: No crashes

---

## 4. Test Data Preparation

### A. Video Collection

```bash
# Directory structure
data/test-videos/
├── scenario-1/
│   ├── test1.mp4
│   ├── test2.mp4
│   └── ground_truth.json
├── scenario-2/
│   ├── test1.mp4
│   └── ground_truth.json
...
```

### B. Ground Truth Annotation

```json
{
  "video": "scenario-1/test1.mp4",
  "annotations": [
    {
      "frame": 120,
      "timestamp": 4.0,
      "intrusion": true,
      "roi": "Entrance",
      "bbox": [100, 200, 150, 300]
    },
    {
      "frame": 350,
      "timestamp": 11.67,
      "intrusion": false,
      "note": "Object outside ROI"
    }
  ]
}
```

### C. Automated Test Script

```python
def run_test_scenario(scenario_name, config_path):
    """Run test for a specific scenario"""

    # Load test videos and ground truth
    videos = load_test_videos(scenario_name)
    ground_truth = load_ground_truth(scenario_name)

    results = []

    for video_path in videos:
        # Run detection system
        detections = run_detection(video_path, config_path)

        # Compare with ground truth
        metrics = evaluate_detections(detections, ground_truth)

        results.append({
            'video': video_path,
            'precision': metrics['precision'],
            'recall': metrics['recall'],
            'f1_score': metrics['f1_score'],
            'fps': metrics['fps']
        })

    # Generate report
    generate_report(scenario_name, results)

    return results
```

---

## 5. Test Execution Plan

### Phase 1: Basic Scenarios (Week 1)
```bash
# Run easy scenarios first
python test/run_scenario.py --scenario S1
python test/run_scenario.py --scenario S2
```

### Phase 2: Challenging Conditions (Week 2)
```bash
python test/run_scenario.py --scenario S3
python test/run_scenario.py --scenario S4
python test/run_scenario.py --scenario S5
```

### Phase 3: Edge Cases (Week 3)
```bash
python test/run_scenario.py --scenario S6
python test/run_scenario.py --scenario S7
python test/run_scenario.py --scenario S8
```

### Phase 4: Comprehensive Test (Week 4)
```bash
# Run all scenarios
python test/run_all_scenarios.py

# Generate comprehensive report
python test/generate_report.py --all
```

---

## 6. Success Criteria

| Metric | Easy | Medium | Hard |
|--------|------|--------|------|
| Precision | >90% | >80% | >60% |
| Recall | >95% | >85% | >70% |
| F1-Score | >92% | >82% | >65% |
| FPS | >25 | >20 | >15 |
| Latency | <200ms | <300ms | <500ms |

---

## 7. Test Report Template

```markdown
# Test Report: Scenario X

## Configuration
- Date: YYYY-MM-DD
- System: [Hardware specs]
- Software: [Version]

## Results
- Total frames: 1000
- True positives: 45
- False positives: 5
- False negatives: 3
- Precision: 90%
- Recall: 93.75%
- F1-Score: 91.8%

## Performance
- Average FPS: 27.3
- Min FPS: 22.1
- Max FPS: 30.0
- Average latency: 180ms

## Issues Found
1. False positive when tree branch moves
2. Missed detection when person partially occluded

## Recommendations
- Increase time_threshold to 1.5s
- Add region growing for better segmentation
```

---

**Ngày tạo**: Tháng 1/2025
